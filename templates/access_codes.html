{% extends "base.html" %}

{% block title %}🎟️ Access Codes{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">🎟️ Player Access Codes</h1>
</div>

<!-- Create New Code Section -->
<div class="card-base">
  <h4 class="section-title">➕ Generate New Code</h4>
  <div class="row g-10">
    <div class="col-md-3">
      <input type="text" id="codeTitle" class="input-base" placeholder="Give your group a name">
    </div>
    <div class="col-md-4">
      <button class="btn-base btn-accent" onclick="createAccessCode()">🎟️ Generate Code</button>
    </div>
  </div>
</div>

<!-- Existing Codes Section -->
<div class="card-base">
  <h4>🔑 Your Access Codes</h4>
  
  <ul class="list-group mt-3">
    {% for code, data in codes.items() %}
    <li class="list-group-item d-flex flex-column hover-subtle">
        <div class="code-badge">{{ data.created_at|default('New') }}</div>
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <span class="access-code">{{ code }}</span>
            <strong>{{ data.title }}</strong>
          </div>
          <button class="btn-base btn-danger btn-sm" onclick="deleteCode('{{ code }}')">🗑️</button>
        </div>
        <div class="code-actions">
          <button class="btn-base btn-outline-accent btn-sm" onclick="copyCode('{{ code }}')">📋 Copy Code</button>
          <button class="btn-base btn-outline-accent btn-sm" onclick="copyLink('{{ code }}')">🔗 Copy Link</button>
        </div>
        <div class="share-link mt-2" id="share-link-{{ code }}">
          {{ request.url_root }}player-access?code={{ code }}
        </div>
      </li>
    {% else %}
    <li class="list-group-item d-flex flex-column hover-subtle">You haven't created any access codes yet.</li>
    {% endfor %}
  </ul>
</div>

<!-- How to Use Section -->
<div class="card-base">
  <h4>ℹ️ How to Use Access Codes</h4>
  <p>Share these codes with your players to give them access to your coaching portal.</p>
  <ol>
    <li>Generate a new code with a descriptive title for your group</li>
    <li>Copy the code or share link and send it to your players</li>
    <li>Players can enter the code at the login screen to access their portal</li>
    <li>The portal includes your calendar, bulletin board, and weather forecasts</li>
  </ol>
  <p class="text-muted small">Note: Each code provides access to the same content from your coach profile.</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
  function createAccessCode() {
    const title = document.getElementById("codeTitle").value.trim();
    if (!title) {
      alert("⚠️ Please enter a title.");
      return;
    }

    fetch("/access-codes", {
      method: "POST",
      headers: { "Content-Type": "application/x-www-form-urlencoded" },
      body: new URLSearchParams({ title })
    }).then(res => {
      if (res.ok) {
        location.reload(); // You can also dynamically inject the new item
      }
    });
  }
  
  function copyCode(code) {
    navigator.clipboard.writeText(code).then(() => {
      showToast(`Code ${code} copied to clipboard!`);
    });
  }
  
  function copyLink(code) {
    const link = document.getElementById(`share-link-${code}`).innerText;
    navigator.clipboard.writeText(link).then(() => {
      showToast("Link copied to clipboard!");
    });
  }
  
  function showToast(message) {
    // Create a toast notification
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 p-3';
    toast.style.zIndex = 11;
    toast.innerHTML = `
      <div class="toast show animate-fade-in" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
          <strong class="me-auto">🎾 Tennis Toolbox</strong>
          <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body">
          ${message}
        </div>
      </div>
    `;
    document.body.appendChild(toast);
    
    // Remove after 3 seconds
    setTimeout(() => {
      toast.remove();
    }, 3000);
  }

  function deleteCode(code) {
    if (!confirm("Are you sure you want to delete this access code?")) return;

    fetch(`/delete-access-code/${code}`, {
      method: "POST"
    }).then(response => {
      if (response.ok) {
        const item = document.getElementById(`code-${code}`);
        // If we can find the item directly, remove it, otherwise reload
        if (item) {
          // Add fade-out animation
          item.style.transition = 'opacity 0.3s, transform 0.3s';
          item.style.opacity = '0';
          item.style.transform = 'translateY(20px)';
          
          // Remove after animation completes
          setTimeout(() => item.remove(), 300);
        } else {
          location.reload();
        }
      }
    });
  }
</script>
{% endblock %}