<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>🎟️ Access Codes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="/static/colours.css" rel="stylesheet">
  <link href="/static/typography.css" rel="stylesheet">
</head>
<body>
  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
  {% endwith %}
  
<div class="container py-4">
  <div class="page-title-container">
    <h1 class="page-title">🎟️ Player Access Codes</h1>
    <div class="title-nav-buttons">
      <a href="{% if current_user.is_authenticated %}/home{% else %}/login{% endif %}" class="btn btn-outline-success me-2">🏠 Home</a>
      <a href="/guide" class="btn btn-outline-success">📘 Coach's Guide</a>
    </div>
  </div>


  <!-- Create New Code Section -->
  <div class="card-section">
    <h4>➕ Generate New Code</h4>
    <div class="row g-3">
      <div class="col-md-8">
        <input type="text" id="codeTitle" class="form-control" placeholder="Enter portal title (e.g. Summer Camp 2025)">
      </div>
      <div class="col-md-4">
        <button class="btn tennis-btn w-100" onclick="createAccessCode()">🎟️ Generate Code</button>
      </div>
    </div>
  </div>

  <!-- Existing Codes Section -->
  <div class="card-section">
    <h4>🔑 Your Access Codes</h4>
    
    <ul class="list-group mt-3">
      {% for code, data in codes.items() %}
        <li class="list-group-item d-flex flex-column access-code-item">
          <div class="code-badge">{{ data.created_at|default('New') }}</div>
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <span class="access-code">{{ code }}</span>
              <strong>{{ data.title }}</strong>
            </div>
            <button class="btn btn-sm btn-danger" onclick="deleteCode('{{ code }}')">🗑️</button>
          </div>
          <div class="code-actions">
            <button class="btn btn-sm btn-outline-success copy-btn" onclick="copyCode('{{ code }}')">📋 Copy Code</button>
            <button class="btn btn-sm btn-outline-success copy-btn" onclick="copyLink('{{ code }}')">🔗 Copy Link</button>
          </div>
          <div class="share-link mt-2" id="share-link-{{ code }}">
            {{ request.url_root }}player-access?code={{ code }}
          </div>
        </li>
      {% else %}
        <li class="list-group-item text-muted text-center">You haven't created any access codes yet.</li>
      {% endfor %}
    </ul>
  </div>

  <!-- How to Use Section -->
  <div class="card-section">
    <h4>ℹ️ How to Use Access Codes</h4>
    <p>Share these codes with your players to give them access to your coaching portal.</p>
    <ol>
      <li>Generate a new code with a descriptive title for your group</li>
      <li>Copy the code or share link and send it to your players</li>
      <li>Players can enter the code at the login screen to access their portal</li>
      <li>The portal includes your calendar, bulletin board, and weather forecasts</li>
    </ol>
    <p class="text-muted small">Note: Each code provides access to the same content from your coach profile.</p>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    function createAccessCode() {
      const title = document.getElementById("codeTitle").value.trim();
      if (!title) {
        alert("⚠️ Please enter a title.");
        return;
      }
  
      fetch("/access-codes", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: new URLSearchParams({ title })
      }).then(res => {
        if (res.ok) {
          location.reload(); // You can also dynamically inject the new item
        }
      });
    }
    
    function copyCode(code) {
      navigator.clipboard.writeText(code).then(() => {
        showToast(`Code ${code} copied to clipboard!`);
      });
    }
    
    function copyLink(code) {
      const link = document.getElementById(`share-link-${code}`).innerText;
      navigator.clipboard.writeText(link).then(() => {
        showToast("Link copied to clipboard!");
      });
    }
    
    function showToast(message) {
      // Create a toast notification
      const toast = document.createElement('div');
      toast.className = 'position-fixed bottom-0 end-0 p-3';
      toast.style.zIndex = 11;
      toast.innerHTML = `
        <div class="toast show" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="toast-header">
            <strong class="me-auto">🎾 Tennis Toolbox</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
          <div class="toast-body">
            ${message}
          </div>
        </div>
      `;
      document.body.appendChild(toast);
      
      // Remove after 3 seconds
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
  </script>

  <script>
    function deleteCode(code) {
      if (!confirm("Are you sure you want to delete this access code?")) return;

      fetch(`/delete-access-code/${code}`, {
        method: "POST"
      }).then(response => {
        if (response.ok) {
          const item = document.getElementById(`code-${code}`);
          if (item) item.remove();
          else location.reload();
        }
      });
    }
  </script>
</body>
</html>