{% extends "base.html" %}

{% block title %}🎾 Tennis Match Organizer{% endblock %}

{% block content %}
  <div class="page-title-container">
    <h1 class="page-title">🎾 Tennis Match Organizer</h1>
    <p class="page-subtitle">Create fair and balanced tennis matches in seconds</p>
  </div>

  <form method="POST" action="/index" enctype="multipart/form-data">
    <!-- CSRF Token Protection (only if available) -->
    {% if csrf_available %}
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
    {% endif %}
    
    <!-- Session Setup Card -->
    <div class="card-base">
      <h4 class="section-title">🎯 Session Setup</h4>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Courts Available</label>
          <div class="input-group">
            <span class="input-group-text">🏟️</span>
            <input type="number" class="form-control" name="courts" min="1" max="20" value="{{ courts }}" required>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Matches per Player</label>
          <div class="input-group">
            <span class="input-group-text">🔄</span>
            <input type="number" class="form-control" name="num_matches" min="1" max="10" value="{{ num_matches }}" required>
          </div>
        </div>
        <div class="col-md-4">
          <label class="form-label">Match Format</label>
          <div class="input-group">
            <span class="input-group-text">🎾</span>
            <select class="form-control" name="match_type" required>
              <option value="singles" {% if match_type == "singles" %}selected{% endif %}>Singles</option>
              <option value="doubles" {% if match_type == "doubles" %}selected{% endif %}>Doubles</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Player Management Card -->
    <div class="card-base">
      <h4 class="section-title">👤 Player Management</h4>
      
      <!-- Add Player Section -->
      <div class="card-border-left">
        <h6 class="text-primary mb-3">Add Individual Player</h6>
        <div class="row g-3">
          <div class="col-md-5">
            <input type="text" name="name" class="form-control" placeholder="Enter player name" id="playerName" maxlength="50" pattern="[a-zA-Z0-9\s\-']+" title="Only letters, numbers, spaces, hyphens and apostrophes allowed">
          </div>
          <div class="col-md-3">
            <select name="grade" class="form-control" id="playerGrade" required>
              <option value="">Select Grade</option>
              <option value="1">Grade 1 (Strongest)</option>
              <option value="2">Grade 2 (Strong)</option>
              <option value="3">Grade 3 (Medium)</option>
              <option value="4">Grade 4 (Beginner)</option>
            </select>
          </div>
          <div class="col-md-4">
            <button type="submit" name="add_player" value="true" class="btn-base btn-accent w-100" onclick="return validateAddPlayer()">
              ➕ Add Player
            </button>
          </div>
        </div>
      </div>

      <!-- CSV Upload Section -->
      <div class="card-border-left" style="border-left-color: #3498db;">
        <h6 class="text-info mb-3">📤 Bulk Upload via CSV</h6>
        <div class="row g-3">
          <div class="col-md-8">
            <input type="file" name="csv_file" accept=".csv" class="form-control" id="csvFileInput">
            <small class="text-muted">Format: <code>name,grade</code> (e.g., "John Smith,2"). Max file size: 1MB, Max 100 players.</small>
          </div>
          <div class="col-md-4">
            <button type="submit" name="upload_csv" value="true" class="btn-base btn-info w-100" onclick="return validateCSVUpload()" formnovalidate>
              📎 Upload CSV
            </button>
          </div>
        </div>
        {% if error %}
          <div class="alert alert-danger mt-3 mb-0">
            <i class="bi bi-exclamation-triangle"></i> {{ error }}
          </div>
        {% endif %}
      </div>
    </div>

    <!-- Current Players List -->
    <div class="card-base" id="players-section">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h4 class="section-title mb-0">👥 Current Players</h4>
        <div class="badge badge-base status-info">{{ players|length }} players</div>
      </div>
      
      {% if players %}
        <div class="row g-3">
          {% for player in players %}
            <div class="col-md-6 col-lg-4">
              <div class="player-card">
                <div class="player-info">
                  <div class="player-name">{{ player.name|e }}</div>
                  <div class="player-grade">Grade {{ player.grade }}</div>
                  {% if player.max_rounds is defined %}
                    <div class="badge badge-base status-warning">{{ player.max_rounds }} rounds max</div>
                  {% endif %}
                </div>
                <div class="player-actions">
                  <button type="button" class="btn-base btn-accent btn-sm" 
                         onclick="confirmRemovePlayer('{{ player.name|e }}')">
                    🗑️ Remove
                  </button>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">👥</div>
          <h6>No Players Added Yet</h6>
          <p class="text-muted">Add players individually or upload a CSV file to get started.</p>
        </div>
      {% endif %}
    </div>
    
    <!-- Action Controls -->
    {% if players %}
    <div class="card-base">
      <div class="action-controls">
        <button type="button" class="btn-base btn-accent btn-lg" onclick="organizeMatches()">
          🎯 Organize Matches
        </button>
        <button type="button" class="btn-base btn-secondary" onclick="reshuffleAll()">
          🔀 Reshuffle All
        </button>
        <button type="button" class="btn-base btn-outline-danger" 
               onclick="confirmReset()">
          🔁 Reset Everything
        </button>
      </div>
    </div>
    {% endif %}

    <!-- Match Schedule -->
    {% if matchups and rounds %}
    <div class="card-base" id="matches-section">
      <div class="schedule-header">
        <h4 class="section-title">📋 Match Schedule</h4>
      </div>

      <!-- Schedule by Round -->
      <div id="schedule-round" class="schedule-container">
        {% for round_num, matches in rounds.items() %}
          <div class="round-section">
            <div class="round-header">
              <h5 class="round-title">Round {{ round_num }}</h5>
              <button type="button" class="btn-base btn-info btn-sm"
                     onclick="reshuffleRound({{ round_num }})"
                     data-round="{{ round_num }}">
                🔀 Reshuffle
              </button>
            </div>
            
            <div class="matches-grid">
              {% for court_num, match in matches %}
                <div class="match-card">
                  <div class="court-label">Court {{ court_num }}</div>
                  <div class="match-players">
                    {% if match|length == 2 %}
                      <div class="vs-match">
                        <div class="player">
                          <span class="name">{{ match[0].name|e }}</span>
                          <span class="grade">G{{ match[0].grade }}</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="player">
                          <span class="name">{{ match[1].name|e }}</span>
                          <span class="grade">G{{ match[1].grade }}</span>
                        </div>
                      </div>
                    {% else %}
                      <div class="doubles-match">
                        <div class="team">
                          <div class="team-players">
                            <span class="name">{{ match[0].name|e }}</span> & <span class="name">{{ match[1].name|e }}</span>
                          </div>
                          <span class="avg-grade">Avg G{{ ((match[0].grade + match[1].grade) / 2) | round(1) }}</span>
                        </div>
                        <div class="vs">VS</div>
                        <div class="team">
                          <div class="team-players">
                            <span class="name">{{ match[2].name|e }}</span> & <span class="name">{{ match[3].name|e }}</span>
                          </div>
                          <span class="avg-grade">Avg G{{ ((match[2].grade + match[3].grade) / 2) | round(1) }}</span>
                        </div>
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}
            </div>
            
            <!-- Players sitting out -->
            {% set playing_players = [] %}
            {% for court_num, match in matches %}
              {% for player in match %}
                {% set _ = playing_players.append(player.name) %}
              {% endfor %}
            {% endfor %}
            
            {% set sitting_out = [] %}
            {% for player in players %}
              {% if player.name not in playing_players %}
                {% set _ = sitting_out.append(player.name) %}
              {% endif %}
            {% endfor %}
            
            {% if sitting_out %}
              <div class="sitting-out">
                <strong>🪑 Sitting out:</strong> {{ sitting_out|join(', ')|e }}
              </div>
            {% endif %}
          </div>
        {% endfor %}
      </div>

    {% elif players %}
    <div class="card-base">
      <div class="empty-state">
        <div class="empty-icon">📋</div>
        <h6>No Matches Organized Yet</h6>
        <p class="text-muted">Click "Organize Matches" to create a balanced match schedule.</p>
        {% if players|length < (2 if match_type == "singles" else 4) %}
          <div class="alert alert-warning mt-3">
            ⚠️ You need at least {{ 2 if match_type == "singles" else 4 }} players for {{ match_type }} matches.
          </div>
        {% endif %}
      </div>
    </div>
    {% endif %}
  </form>

  <!-- Timer Widget -->
  {% if matchups and rounds %}
  <div class="card-base">
    <div class="timer-widget">
      <h5 class="timer-title">⏱️ Match Timer</h5>
      <div class="timer-display" id="main-timer-display">20:00</div>
      <div class="timer-controls">
        <button class="btn-base btn-success btn-sm" onclick="startClock(document.getElementById('main-timer-display'))">
          ▶️ Start
        </button>
        <button class="btn-base btn-warning btn-sm" onclick="pauseClock()">
          ⏸️ Pause
        </button>
        <div class="timer-input">
          <input type="number" id="custom-minutes" class="form-control" min="1" max="60" value="20" placeholder="Min">
          <button class="btn-base btn-outline-secondary btn-sm" onclick="setClockInput(document.getElementById('main-timer-display'))">
            Set
          </button>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

{% endblock %}

{% block extra_js %}
<script>
// Timer variables
let timerInterval = null;
let isPaused = false;
let timeRemaining = 20 * 60; // 20 minutes in seconds

// Validation Functions
function validateAddPlayer() {
  const name = document.getElementById('playerName').value.trim();
  const grade = document.getElementById('playerGrade').value;
  
  if (!name) {
    alert('Please enter a player name');
    return false;
  }
  
  if (!grade) {
    alert('Please select a grade');
    return false;
  }
  
  // Check for duplicate names
  const existingPlayers = document.querySelectorAll('.player-name');
  for (let player of existingPlayers) {
    if (player.textContent.toLowerCase() === name.toLowerCase()) {
      alert('Player with this name already exists');
      return false;
    }
  }
  
  return true;
}

function validateCSVUpload() {
  const fileInput = document.getElementById('csvFileInput');
  if (!fileInput.files.length) {
    alert('Please select a CSV file');
    return false;
  }
  return true;
}

function validateOrganizeMatches() {
  const players = document.querySelectorAll('.player-card');
  const matchType = document.querySelector('select[name="match_type"]').value;
  const minPlayers = matchType === 'singles' ? 2 : 4;
  
  if (players.length < minPlayers) {
    alert(`You need at least ${minPlayers} players for ${matchType} matches`);
    return false;
  }
  
  return true;
}

// CSRF Token helper
function getCSRFToken() {
  const csrfInput = document.querySelector('input[name="csrf_token"]');
  return csrfInput ? csrfInput.value : '';
}

// Scroll position helpers
function saveScrollPosition() {
  sessionStorage.setItem('scrollPosition', window.pageYOffset);
}

function restoreScrollPosition() {
  const scrollPos = sessionStorage.getItem('scrollPosition');
  if (scrollPos) {
    window.scrollTo(0, parseInt(scrollPos));
    sessionStorage.removeItem('scrollPosition');
  }
}

// Empty state removal
function removeAllEmptyStates() {
  const emptyStates = document.querySelectorAll('.empty-state');
  emptyStates.forEach(state => {
    const card = state.closest('.card-base');
    if (card && card.id !== 'players-section') {
      card.remove();
    }
  });
}

// Event handler reattachment
function reattachEventHandlers() {
  // Reattach reshuffle round buttons
  const reshuffleButtons = document.querySelectorAll('[onclick*="reshuffleRound"]');
  reshuffleButtons.forEach(button => {
    const roundNum = button.getAttribute('data-round');
    if (roundNum) {
      button.onclick = () => reshuffleRound(parseInt(roundNum));
    }
  });
}

// Main organize matches function - FIXED VERSION
function organizeMatches() {
  if (!validateOrganizeMatches()) {
    return;
  }
  
  // Show loading state
  const button = event.target;
  const originalText = button.innerHTML;
  button.innerHTML = '⏳ Organizing...';
  button.disabled = true;
  
  const formData = new FormData();
  formData.append('organize_matches', 'true');
  
  // Add CSRF token if available
  const csrfToken = getCSRFToken();
  if (csrfToken) {
    formData.append('csrf_token', csrfToken);
  }
  
  // Add current form state
  const form = document.querySelector('form');
  const inputs = form.querySelectorAll('input[type="number"], select');
  inputs.forEach(input => {
    if (input.name && input.value) {
      formData.append(input.name, input.value);
    }
  });
  
  fetch('/index', {
    method: 'POST',
    body: formData
  })
  .then(response => {
    if (!response.ok) {
      throw new Error('Network response was not ok');
    }
    return response.text();
  })
  .then(html => {
    // Parse the response and update the page content
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    
    // Update CSRF token if present
    const newToken = doc.querySelector('input[name="csrf_token"]');
    const currentToken = document.querySelector('input[name="csrf_token"]');
    if (newToken && currentToken) {
      currentToken.value = newToken.value;
    }
    
    // Remove any existing empty states
    removeAllEmptyStates();
    
    // Update or create matches section
    const newMatchesSection = doc.querySelector('#matches-section');
    const currentMatchesSection = document.querySelector('#matches-section');
    
    if (newMatchesSection) {
      if (currentMatchesSection) {
        // Update existing matches section
        currentMatchesSection.innerHTML = newMatchesSection.innerHTML;
      } else {
        // Create new matches section
        const actionControls = document.querySelector('.action-controls').closest('.card-base');
        const matchesHTML = `<div class="card-base" id="matches-section">${newMatchesSection.innerHTML}</div>`;
        actionControls.insertAdjacentHTML('afterend', matchesHTML);
      }
      reattachEventHandlers();
    }
    
    // Add timer widget if not present and matches were created
    const newTimerWidget = doc.querySelector('.timer-widget');
    const currentTimerWidget = document.querySelector('.timer-widget');
    
    if (newTimerWidget && !currentTimerWidget && newMatchesSection) {
      const matchesSection = document.querySelector('#matches-section');
      if (matchesSection) {
        const timerHTML = `<div class="card-base"><div class="timer-widget">${newTimerWidget.outerHTML}</div></div>`;
        matchesSection.insertAdjacentHTML('afterend', timerHTML);
        
        // Initialize timer
        const display = document.getElementById('main-timer-display');
        if (display) {
          timeRemaining = 20 * 60; // Reset to 20 minutes
          updateClockDisplay(display);
        }
      }
    }
    
    // Final cleanup
    setTimeout(removeAllEmptyStates, 100);
    
    // Show success message
    showMessage('Matches organized successfully!', 'success');
    
  })
  .catch(error => {
    console.error('Error organizing matches:', error);
    showMessage('Error organizing matches. Trying alternative method...', 'warning');
    
    // Fallback to form submission if AJAX fails
    saveScrollPosition();
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'organize_matches';
    hiddenInput.value = 'true';
    form.appendChild(hiddenInput);
    form.submit();
  })
  .finally(() => {
    // Restore button state
    button.innerHTML = originalText;
    button.disabled = false;
  });
}

// Simplified reshuffle functions
function reshuffleAll() {
  if (confirm('This will reshuffle all players and create new matches. Continue?')) {
    saveScrollPosition();
    const form = document.querySelector('form');
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'reshuffle';
    hiddenInput.value = 'true';
    form.appendChild(hiddenInput);
    form.submit();
  }
}

function reshuffleRound(roundNum) {
  saveScrollPosition();
  const form = document.querySelector('form');
  const hiddenInput = document.createElement('input');
  hiddenInput.type = 'hidden';
  hiddenInput.name = 'reshuffle_round';
  hiddenInput.value = roundNum;
  form.appendChild(hiddenInput);
  form.submit();
}

// Player management functions
function confirmRemovePlayer(playerName) {
  if (confirm(`Remove ${playerName} from the session?`)) {
    const form = document.querySelector('form');
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'remove_player';
    hiddenInput.value = playerName;
    form.appendChild(hiddenInput);
    form.submit();
  }
}

function confirmReset() {
  if (confirm('This will remove all players and matches. Are you sure?')) {
    const form = document.querySelector('form');
    const hiddenInput = document.createElement('input');
    hiddenInput.type = 'hidden';
    hiddenInput.name = 'reset';
    hiddenInput.value = 'true';
    form.appendChild(hiddenInput);
    form.submit();
  }
}

// Timer functions
function updateClockDisplay(display) {
  const minutes = Math.floor(timeRemaining / 60);
  const seconds = timeRemaining % 60;
  display.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
  
  if (timeRemaining <= 0) {
    display.style.color = 'var(--danger)';
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    showMessage('Time\'s up!', 'warning');
  } else if (timeRemaining <= 60) {
    display.style.color = 'var(--warning)';
  } else {
    display.style.color = 'var(--navy)';
  }
}

function startClock(display) {
  if (timerInterval) {
    clearInterval(timerInterval);
  }
  
  isPaused = false;
  timerInterval = setInterval(() => {
    if (!isPaused && timeRemaining > 0) {
      timeRemaining--;
      updateClockDisplay(display);
    }
  }, 1000);
}

function pauseClock() {
  isPaused = !isPaused;
  const button = event.target;
  button.textContent = isPaused ? '▶️ Resume' : '⏸️ Pause';
}

function setClockInput(display) {
  const customMinutes = document.getElementById('custom-minutes').value;
  if (customMinutes && customMinutes > 0 && customMinutes <= 60) {
    timeRemaining = parseInt(customMinutes) * 60;
    updateClockDisplay(display);
    if (timerInterval) {
      clearInterval(timerInterval);
      timerInterval = null;
    }
    isPaused = false;
    document.querySelector('[onclick*="pauseClock"]').textContent = '⏸️ Pause';
  }
}

// Message display function
function showMessage(message, type = 'info') {
  // Remove existing messages
  const existingMessages = document.querySelectorAll('.temp-message');
  existingMessages.forEach(msg => msg.remove());
  
  // Create new message
  const messageDiv = document.createElement('div');
  messageDiv.className = `alert alert-${type} temp-message`;
  messageDiv.style.position = 'fixed';
  messageDiv.style.top = '20px';
  messageDiv.style.right = '20px';
  messageDiv.style.zIndex = '9999';
  messageDiv.style.maxWidth = '300px';
  messageDiv.textContent = message;
  
  document.body.appendChild(messageDiv);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    if (messageDiv.parentNode) {
      messageDiv.remove();
    }
  }, 3000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  // Restore scroll position if returning from form submission
  restoreScrollPosition();
  
  // Initialize timer display if present
  const timerDisplay = document.getElementById('main-timer-display');
  if (timerDisplay) {
    updateClockDisplay(timerDisplay);
  }
  
  // Clear form inputs after successful submission
  const urlParams = new URLSearchParams(window.location.search);
  if (urlParams.get('success')) {
    document.getElementById('playerName').value = '';
    document.getElementById('playerGrade').value = '';
  }
});

// Prevent form submission on Enter key in player name field
document.addEventListener('DOMContentLoaded', function() {
  const playerNameInput = document.getElementById('playerName');
  if (playerNameInput) {
    playerNameInput.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        if (validateAddPlayer()) {
          document.querySelector('button[name="add_player"]').click();
        }
      }
    });
  }
});
</script>
{% endblock %}