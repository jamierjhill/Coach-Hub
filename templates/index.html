<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-FL37QBZMLC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-FL37QBZMLC');
</script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>🎾 Tennis Match Organizer</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #e8f5e9;
      font-family: 'Segoe UI', sans-serif;
    }

    .card-section {
      background-color: #ffffff;
      border-left: 6px solid #1b5e20;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.05);
    }

    .tennis-btn {
      background-color: #43a047;
      color: white;
      font-weight: bold;
    }

    .tennis-btn:hover {
      background-color: #2e7d32;
    }

    .match {
      background-color: #c8e6c9;
      padding: 10px;
      border-radius: 8px;
      margin-bottom: 8px;
    }

    .player-box {
      background-color: #e0f2f1;
      padding: 10px;
      border-radius: 6px;
      margin-bottom: 8px;
    }

    .timer-controls {
      background: #ffffff;
      border-left: 6px solid #1b5e20;
      padding: 20px;
      border-radius: 12px;
      margin-top: 30px;
    }

    footer {
      text-align: center;
      margin-top: 60px;
      font-size: 14px;
      color: #555;
    }

    .round-header, .court-header {
      margin-bottom: 10px;
      padding: 5px 0;
      border-bottom: 1px solid #c8e6c9;
    }

    .round-reshuffle-btn, .court-reshuffle-btn {
      font-size: 0.8rem;
      padding: 4px 8px;
    }
  </style>
</head>
<body>

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
  {% endwith %}
  
<div class="container py-4">
  <h2 class="text-success text-center mb-4">🎾 Match Organizer</h2>

  <!-- Navigation Buttons -->
  <div class="text-center mb-3">
    <a href="{% if current_user.is_authenticated %}/home{% else %}/login{% endif %}" class="btn btn-outline-success me-2">🏠 Home</a>
    <a href="/guide" class="btn btn-outline-success">📘 Coach's Guide</a>
  </div>

  <form method="POST" enctype="multipart/form-data">

    <!-- Session Setup -->
    <div class="card-section">
      <h4>🎯 Session Setup</h4>
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">Courts</label>
          <input type="number" class="form-control" name="courts" min="1" value="{{ courts }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Matches per player</label>
          <input type="number" class="form-control" name="num_matches" min="1" value="{{ num_matches }}">
        </div>
        <div class="col-md-4">
          <label class="form-label">Format</label>
          <select class="form-select" name="match_type">
            <option value="singles" {% if match_type == "singles" %}selected{% endif %}>Singles</option>
            <option value="doubles" {% if match_type == "doubles" %}selected{% endif %}>Doubles</option>
          </select>
        </div>
      </div>
    </div>

    <!-- Add / Upload Players -->
    <div class="card-section">
      <h4>👤 Add or Upload Players</h4>
      <div class="row g-3">
        <div class="col-md-6">
          <input type="text" name="name" class="form-control" placeholder="Player name">
        </div>
        <div class="col-md-4">
          <input type="number" name="grade" class="form-control" placeholder="Grade (1–4)" min="1" max="4">
        </div>
        <div class="col-md-2">
          <button type="submit" name="add_player" class="btn tennis-btn w-100">➕ Add</button>
        </div>
      </div>

<!-- CSV Upload Section in index.html -->
<div class="mt-3">
  <hr>
  <h6>📤 Upload from CSV</h6>
  <div class="row g-3">
    <div class="col-md-8">
      <input type="file" name="csv_file" accept=".csv" class="form-control">
    </div>
    <div class="col-md-4">
      <button type="button" onclick="return uploadCSV()" class="btn tennis-btn w-100">📎 Upload CSV</button>
    </div>
  </div>
  <small class="text-muted d-block mt-2">CSV format: <code>name,grade</code></small>
  {% if error %}
    <div class="text-danger fw-bold mt-2">⚠️ {{ error }}</div>
  {% endif %}
</div>
    </div>

    <!-- Player List -->
    <div class="card-section">
      <h4>👟 Current Players ({{ players|length }})</h4>
      <div class="row row-cols-1 row-cols-md-2 g-3">
        {% for player in players %}
          <div class="col">
            <div class="player-box d-flex justify-content-between align-items-center">
              <span>🧍‍♂️ {{ player.name }} (Grade {{ player.grade }})</span>
              <button type="submit" name="remove_player" value="{{ player.name }}" class="btn btn-danger btn-sm">🗑️</button>
            </div>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="text-center my-4">
      <button type="button" onclick="return organizeMatches()" class="btn tennis-btn me-2">🎯 Organize Matches</button>
      <button type="button" onclick="return reshuffleAll()" class="btn tennis-btn me-2">🔀 Reshuffle</button>
      <button type="submit" name="reset" class="btn btn-outline-danger">🔁 Reset All</button>
    </div>

  <!-- Match Schedule -->
  <div class="card-section">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">📋 Match Schedule</h4>
      <div>
        <label for="scheduleToggle" class="form-label me-2">🔀 View By</label>
        <select class="form-select d-inline w-auto" id="scheduleToggle" onchange="toggleScheduleView(this.value)">
          <option value="court">Court</option>
          <option value="round">Round</option>
        </select>
      </div>
    </div>

    <!-- Match Schedule by Round -->
    <div id="schedule-round" style="display: none;">
      {% for round_num, matches in rounds.items() %}
        <div class="round-header d-flex justify-content-between align-items-center">
          <h5 class="text-success mb-0">Round {{ round_num }}</h5>
          <button type="button" onclick="return reshuffleRound({{ round_num }})" class="btn btn-sm btn-outline-success round-reshuffle-btn">🔀 Reshuffle Round {{ round_num }}</button>
        </div>
        {% for court_num, match in matches %}
          <div class="match">
            <strong>Court {{ court_num }}:</strong>
            {% if match|length == 2 %}
              {{ match[0].name }} (g{{ match[0].grade }}) vs {{ match[1].name }} (g{{ match[1].grade }})
            {% else %}
              {{ match[0].name }} & {{ match[1].name }} (avg g{{ ((match[0].grade + match[1].grade) / 2) | round(1) }})
              vs {{ match[2].name }} & {{ match[3].name }} (avg g{{ ((match[2].grade + match[3].grade) / 2) | round(1) }})
            {% endif %}
          </div>
        {% endfor %}
      {% endfor %}
    </div>

    <!-- Match Schedule by Court -->
    <div id="schedule-court" style="display: none;">
      {% for court_number in range(1, courts + 1) %}
        <div class="court-header d-flex justify-content-between align-items-center">
          <h5 class="text-success mb-0">Court {{ court_number }}</h5>
          {% if matchups[court_number - 1] %}
            <button type="button" onclick="return reshuffleCourt({{ court_number }})" class="btn btn-sm btn-outline-success court-reshuffle-btn">🔀 Reshuffle Court {{ court_number }}</button>
          {% endif %}
        </div>
        {% if matchups[court_number - 1] %}
          {% for match, round_num in matchups[court_number - 1] %}
            <div class="match">
              {% if match|length == 2 %}
                {{ match[0].name }} (g{{ match[0].grade }}) vs. {{ match[1].name }} (g{{ match[1].grade }})
              {% else %}
                {{ match[0].name }} & {{ match[1].name }} (avg g{{ ((match[0].grade + match[1].grade) / 2) | round(1) }})
                vs. {{ match[2].name }} & {{ match[3].name }} (avg g{{ ((match[2].grade + match[3].grade) / 2) | round(1) }})
              {% endif %}
              <br><small>Round {{ round_num }}</small>
            </div>
          {% endfor %}
        {% else %}
          <p>No matches scheduled.</p>
        {% endif %}
      {% endfor %}
    </div>
  </div>

  </form>

  <!-- Summary -->
  <div class="card-section">
    <h4>🧮 Player Summary</h4>
    <ul class="list-group list-group-flush">
      {% for player, match_count in player_match_counts.items() %}
        <li class="list-group-item">{{ player }}: {{ match_count }} match{{ 'es' if match_count != 1 else '' }}</li>
      {% endfor %}
    </ul>
  </div>

  <!-- Timer -->
  <div class="timer-controls">
    <h5>⏱️ Match Timer</h5>
    <div id="main-timer-display" class="fs-4 mb-3">20:00</div>
    <div class="d-flex gap-2 justify-content-center mb-2">
      <button class="btn tennis-btn" onclick="startClock(document.getElementById('main-timer-display'))">▶️ Start</button>
      <button class="btn btn-secondary" onclick="pauseClock()">⏸️ Pause</button>
    </div>
    <div class="input-group w-50 mx-auto">
      <input type="number" id="custom-minutes" class="form-control" min="1" max="200" value="20">
      <button class="btn btn-outline-success" onclick="setClockInput(document.getElementById('main-timer-display'))">Set Timer</button>
    </div>
  </div>

  <footer class="mt-5">
    <p>Cooked up by Jamie</p>
  </footer>
</div>

<script>
    let timerInterval;
    let remainingTime = 1200;

    function updateClockDisplay(display) {
      const minutes = String(Math.floor(remainingTime / 60)).padStart(2, '0');
      const seconds = String(remainingTime % 60).padStart(2, '0');
      display.textContent = `${minutes}:${seconds}`;
    }

    function startClock(display) {
      clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        if (remainingTime > 0) {
          remainingTime--;
          updateClockDisplay(display);
        } else {
          clearInterval(timerInterval);
          display.textContent = "Time's up!";
        }
      }, 1000);
    }

    function pauseClock() {
      clearInterval(timerInterval);
    }

    function setClockInput(display) {
      const minutes = parseInt(document.getElementById('custom-minutes').value);
      if (!isNaN(minutes) && minutes > 0 && minutes <= 200) {
        remainingTime = minutes * 60;
        updateClockDisplay(display);
      } else {
        alert("Please enter a number between 1 and 200.");
      }
    }

    window.onload = function () {
      const display = document.getElementById('main-timer-display');
      if (display) updateClockDisplay(display);
    };
</script>

<script>
  function toggleScheduleView(view) {
    const roundDiv = document.getElementById("schedule-round");
    const courtDiv = document.getElementById("schedule-court");
    roundDiv.style.display = view === "round" ? "block" : "none";
    courtDiv.style.display = view === "court" ? "block" : "none";
  }

  window.onload = function () {
    const defaultView = "{{ view_mode }}";
    const selector = document.getElementById("scheduleToggle");
    if (selector) {
      selector.value = defaultView;
      toggleScheduleView(defaultView);
    }
  };
</script>

<script>
function reshuffleRound(roundNum) {
    const formData = new FormData();
    formData.append('reshuffle_round', roundNum);
    
    // Store current scroll position
    const scrollPosition = window.pageYOffset;
    
    fetch('/index', {
        method: 'POST',
        body: formData
    })
    .then(response => response.text())
    .then(html => {
        // Create a temporary DOM element to parse the response
        const parser = new DOMParser();
        const doc = parser.parseFromString(html, 'text/html');
        
        // Extract and update the match schedule section
        const newSchedule = doc.querySelector('#schedule-round');
        const currentSchedule = document.querySelector('#schedule-round');
        if (newSchedule && currentSchedule) {
            currentSchedule.innerHTML = newSchedule.innerHTML;
        }
        
        // Restore scroll position
        window.scrollTo(0, scrollPosition);
    })
    .catch(error => {
        console.error('Error:', error);
        // Fallback to regular form submission if AJAX fails
        document.querySelector('form').submit();
    });
    
    return false;
  }

function reshuffleCourt(courtNum) {
   const formData = new FormData();
   formData.append('reshuffle_court', courtNum);
   
   // Store current scroll position
   const scrollPosition = window.pageYOffset;
   
   fetch('/index', {
       method: 'POST',
       body: formData
   })
   .then(response => response.text())
   .then(html => {
       // Create a temporary DOM element to parse the response
       const parser = new DOMParser();
       const doc = parser.parseFromString(html, 'text/html');
       
       // Extract and update the match schedule section
       const newSchedule = doc.querySelector('#schedule-court');
       const currentSchedule = document.querySelector('#schedule-court');
       if (newSchedule && currentSchedule) {
           currentSchedule.innerHTML = newSchedule.innerHTML;
       }
       
       // Restore scroll position
       window.scrollTo(0, scrollPosition);
   })
   .catch(error => {
       console.error('Error:', error);
       // Fallback to regular form submission if AJAX fails
       document.querySelector('form').submit();
   });
   
   return false; // Prevent default form submission
}

function reshuffleAll() {
   const formData = new FormData();
   formData.append('reshuffle', 'true');
   
   // Store current scroll position
   const scrollPosition = window.pageYOffset;
   
   fetch('/index', {
       method: 'POST',
       body: formData
   })
   .then(response => response.text())
   .then(html => {
       // Create a temporary DOM element to parse the response
       const parser = new DOMParser();
       const doc = parser.parseFromString(html, 'text/html');
       
       // Update both schedule views
       const newScheduleRound = doc.querySelector('#schedule-round');
       const currentScheduleRound = document.querySelector('#schedule-round');
       if (newScheduleRound && currentScheduleRound) {
           currentScheduleRound.innerHTML = newScheduleRound.innerHTML;
       }
       
       const newScheduleCourt = doc.querySelector('#schedule-court');
       const currentScheduleCourt = document.querySelector('#schedule-court');
       if (newScheduleCourt && currentScheduleCourt) {
           currentScheduleCourt.innerHTML = newScheduleCourt.innerHTML;
       }
       
       // Also update the player summary section
       const newSummary = doc.querySelector('.card-section:last-of-type ul.list-group');
       const currentSummary = document.querySelector('.card-section:last-of-type ul.list-group');
       if (newSummary && currentSummary) {
           currentSummary.innerHTML = newSummary.innerHTML;
       }
       
       // Restore scroll position
       window.scrollTo(0, scrollPosition);
   })
   .catch(error => {
       console.error('Error:', error);
       // Fallback to regular form submission if AJAX fails
       const form = document.querySelector('form');
       const input = document.createElement('input');
       input.type = 'hidden';
       input.name = 'reshuffle';
       input.value = 'true';
       form.appendChild(input);
       form.submit();
   });
   
   return false; // Prevent default form submission
}

function organizeMatches() {
   const formData = new FormData(document.querySelector('form'));
   formData.append('organize_matches', 'true');
   
   // Store current scroll position
   const scrollPosition = window.pageYOffset;
   
   fetch('/index', {
       method: 'POST',
       body: formData
   })
   .then(response => response.text())
   .then(html => {
       // Create a temporary DOM element to parse the response
       const parser = new DOMParser();
       const doc = parser.parseFromString(html, 'text/html');
       
       // Update both schedule views
       const newScheduleRound = doc.querySelector('#schedule-round');
       const currentScheduleRound = document.querySelector('#schedule-round');
       if (newScheduleRound && currentScheduleRound) {
           currentScheduleRound.innerHTML = newScheduleRound.innerHTML;
       }
       
       const newScheduleCourt = doc.querySelector('#schedule-court');
       const currentScheduleCourt = document.querySelector('#schedule-court');
       if (newScheduleCourt && currentScheduleCourt) {
           currentScheduleCourt.innerHTML = newScheduleCourt.innerHTML;
       }
       
       // Also update the player summary section
       const newSummary = doc.querySelector('.card-section:last-of-type ul.list-group');
       const currentSummary = document.querySelector('.card-section:last-of-type ul.list-group');
       if (newSummary && currentSummary) {
           currentSummary.innerHTML = newSummary.innerHTML;
       }
       
       // Update error messages if any
       const newError = doc.querySelector('.text-danger.fw-bold');
       const currentError = document.querySelector('.text-danger.fw-bold');
       if (newError && currentError) {
           currentError.innerHTML = newError.innerHTML;
       }
       
       // Restore scroll position
       window.scrollTo(0, scrollPosition);
   })
   .catch(error => {
       console.error('Error:', error);
       // Fallback to regular form submission if AJAX fails
       const form = document.querySelector('form');
       const input = document.createElement('input');
       input.type = 'hidden';
       input.name = 'organize_matches';
       input.value = 'true';
       form.appendChild(input);
       form.submit();
   });
   
   return false; // Prevent default form submission
}

function uploadCSV() {
   const fileInput = document.querySelector('input[name="csv_file"]');
   const file = fileInput.files[0];
   
   if (!file) {
       alert('Please select a file');
       return false;
   }
   
   const formData = new FormData();
   formData.append('csv_file', file);
   formData.append('upload_csv', 'true');
   
   // Store current scroll position
   const scrollPosition = window.pageYOffset;
   
   fetch('/index', {
       method: 'POST',
       body: formData
   })
   .then(response => {
       if (response.redirected && response.url.includes('/login')) {
           // Session expired, redirect to login
           window.location.href = '/login';
           return;
       }
       return response.text();
   })
   .then(html => {
       if (!html) return;
       
       // Update the page content
       const parser = new DOMParser();
       const doc = parser.parseFromString(html, 'text/html');
       
       // Update player list
       const newPlayerList = doc.querySelector('.card-section:nth-of-type(3)');
       const currentPlayerList = document.querySelector('.card-section:nth-of-type(3)');
       if (newPlayerList && currentPlayerList) {
           currentPlayerList.innerHTML = newPlayerList.innerHTML;
       }
       
       // Update error messages
       const newError = doc.querySelector('.text-danger.fw-bold');
       const errorContainer = document.querySelector('.text-danger.fw-bold')?.parentElement || 
                              document.querySelector('.mt-3');
       if (newError && errorContainer) {
           errorContainer.innerHTML = newError.outerHTML;
       } else if (errorContainer && errorContainer.querySelector('.text-danger.fw-bold')) {
           errorContainer.querySelector('.text-danger.fw-bold').remove();
       }
       
       // Clear file input
       fileInput.value = '';
       
       // Restore scroll position
       window.scrollTo(0, scrollPosition);
   })
   .catch(error => {
       console.error('Error:', error);
       // Fallback to regular form submission
       document.querySelector('form').submit();
   });
   
   return false;
}
</script>

</body>
</html>