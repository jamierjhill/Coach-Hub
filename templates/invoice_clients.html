{% extends "base.html" %}

{% block title %}üë• Clients{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">üë• Clients</h1>
  <div class="title-nav-buttons">
    <a href="/invoices" class="btn-base btn-outline-accent btn-sm">‚Üê Invoices</a>
    <a href="/invoices/create" class="btn-base btn-accent btn-sm">‚ûï Create Invoice</a>
  </div>
</div>

<!-- Summary Stats -->
<div class="summary-grid mb-4">
  <div class="summary-card" style="background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: white;">
    <div class="summary-amount">{{ total_clients }}</div>
    <div class="summary-label">Total Clients</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--warning), #e67e22); color: white;">
    <div class="summary-amount">{{ clients_with_outstanding }}</div>
    <div class="summary-label">With Unpaid</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: white;">
    <div class="summary-amount">¬£{{ "%.0f"|format(total_outstanding_all) }}</div>
    <div class="summary-label">Outstanding</div>
  </div>
</div>


<!-- Client List -->
{% if clients %}
<div class="card-base">
    <!-- Search & Filter -->
      <div class="row g-2">
        <div class="col-8">
          <input type="text" id="clientSearch" class="input-base" placeholder="Search clients...">
        </div>
    
    </div>
  <div id="clientsList">
    {% for client in clients %}
    <div class="client-item" 
         data-client-name="{{ client.name|lower }}"
         data-has-outstanding="{{ 'true' if client.total_outstanding > 0 else 'false' }}"
         data-has-overdue="{{ 'true' if client.total_overdue > 0 else 'false' }}">
      
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="flex-grow-1">
          <div class="d-flex align-items-center gap-2 mb-1">
            <h6 class="client-name mb-0">{{ client.name }}</h6>
            {% if client.total_overdue > 0 %}
              <span class="badge-compact badge-danger">OVERDUE</span>
            {% elif client.total_outstanding > 0 %}
              <span class="badge-compact badge-warning">UNPAID</span>
            {% else %}
              <span class="badge-compact badge-success">PAID</span>
            {% endif %}
          </div>
          
          <div class="client-stats">
            {% if client.total_outstanding > 0 %}
              <span class="outstanding-amount">¬£{{ "%.0f"|format(client.total_outstanding) }} unpaid</span>
            {% endif %}
            {% if client.total_paid > 0 %}
              <span class="text-muted"> ‚Ä¢ ¬£{{ "%.0f"|format(client.total_paid) }} paid</span>
            {% endif %}
            <span class="text-muted"> ‚Ä¢ {{ client.total_invoices }} invoice{{ 's' if client.total_invoices != 1 else '' }}</span>
          </div>
        </div>
        
        <div class="d-flex gap-1">
          <a href="/invoices/clients/{{ client.name }}" class="btn-base btn-accent btn-xs">View</a>
          <a href="/invoices/clients/{{ client.name }}/create" class="btn-base btn-outline-accent btn-xs">+</a>
          {% if client.total_outstanding > 0 %}
          <button onclick="shareReminder('{{ client.name }}', {{ client.total_outstanding }})" 
                  class="btn-base btn-outline-secondary btn-xs" title="Send reminder">üì±</button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
  
  <!-- No results message -->
  <div id="noClientsMessage" style="display: none;" class="text-center py-4">
    <div class="text-muted">
      <div style="font-size: 2rem; margin-bottom: 1rem;">üîç</div>
      <p class="mb-2">No clients match your search</p>
      <button onclick="clearFilters()" class="btn-base btn-outline-accent btn-sm">Clear Filters</button>
    </div>
  </div>
</div>

{% else %}
<!-- Empty State -->
<div class="card-base text-center p-4">
  <div class="empty-state">
    <div class="empty-icon">üë•</div>
    <h4 class="mb-2">No Clients Yet</h4>
    <p class="text-muted mb-3">Create your first invoice to start building your client base.</p>
    <a href="/invoices/create" class="btn-base btn-accent">‚ú® Create First Invoice</a>
  </div>
</div>
{% endif %}


{% endblock %}

{% block extra_css %}
<style>
  /* Client Items */
  .client-item {
    padding: 12px;
    border-bottom: 1px solid var(--light-border);
    transition: background-color 0.2s ease;
  }
  
  .client-item:hover {
    background-color: rgba(0, 160, 126, 0.05);
  }
  
  .client-item:last-child {
    border-bottom: none;
  }
  
  .client-name {
    font-weight: 600;
    color: var(--navy);
    font-size: 0.9rem;
  }
  
  .client-stats {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }
  
  .outstanding-amount {
    font-weight: 600;
    color: var(--warning);
  }
  
  .badge-compact {
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .badge-warning {
    background: rgba(247, 201, 72, 0.2);
    color: var(--warning);
  }
  
  .badge-success {
    background: rgba(0, 160, 126, 0.2);
    color: var(--success);
  }
  
  .badge-danger {
    background: rgba(231, 76, 60, 0.2);
    color: var(--danger);
  }
  
  .btn-xs {
    padding: 4px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
  }
  
  /* Mobile optimizations */
  @media (max-width: 576px) {
    .summary-grid {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .summary-card {
      padding: 12px;
    }
    
    .summary-amount {
      font-size: 1.3rem;
    }
    
    .client-item {
      padding: 10px;
    }
    
    .client-name {
      font-size: 0.85rem;
    }
    
    .client-stats {
      font-size: 0.75rem;
    }
    
    .btn-xs {
      padding: 3px 6px;
      font-size: 0.7rem;
    }
    
    .d-flex.gap-1 {
      flex-direction: column;
      gap: 4px !important;
    }
    
    .d-flex.gap-1 .btn-xs {
      width: 100%;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  let allClientItems = [];
  
  document.addEventListener('DOMContentLoaded', function() {
    allClientItems = Array.from(document.querySelectorAll('.client-item'));
    
    document.getElementById('clientSearch')?.addEventListener('input', performSearch);
    document.getElementById('clientFilter')?.addEventListener('change', performSearch);
  });
  
  function performSearch() {
    const searchTerm = document.getElementById('clientSearch')?.value.toLowerCase().trim() || '';
    const filterValue = document.getElementById('clientFilter')?.value || 'all';
    
    let visibleCount = 0;
    
    allClientItems.forEach(item => {
      const clientName = item.dataset.clientName || '';
      const hasOutstanding = item.dataset.hasOutstanding === 'true';
      const hasOverdue = item.dataset.hasOverdue === 'true';
      
      const matchesSearch = !searchTerm || clientName.includes(searchTerm);
      
      let matchesFilter = true;
      switch (filterValue) {
        case 'outstanding':
          matchesFilter = hasOutstanding;
          break;
        case 'paid-up':
          matchesFilter = !hasOutstanding;
          break;
        case 'overdue':
          matchesFilter = hasOverdue;
          break;
      }
      
      const shouldShow = matchesSearch && matchesFilter;
      item.style.display = shouldShow ? 'block' : 'none';
      
      if (shouldShow) visibleCount++;
    });
    
    const noResults = document.getElementById('noClientsMessage');
    if (noResults) {
      noResults.style.display = visibleCount === 0 ? 'block' : 'none';
    }
  }
  
  function clearFilters() {
    const search = document.getElementById('clientSearch');
    const filter = document.getElementById('clientFilter');
    
    if (search) search.value = '';
    if (filter) filter.value = 'all';
    
    performSearch();
  }
  
  function shareReminder(clientName, outstandingAmount) {
    const message = `Hi ${clientName},

Hope you're well! Just a friendly reminder that you have an outstanding balance of ¬£${outstandingAmount.toFixed(2)} for tennis coaching.

If you've already made payment, please ignore this message. Otherwise, please let me know if you need any details.

Thanks!
- {{ current_user.username|title if current_user.username else "Your Coach" }}`;
    
    if (navigator.share) {
      navigator.share({
        title: 'Payment Reminder',
        text: message
      });
    } else {
      const encodedMessage = encodeURIComponent(message);
      window.open(`https://wa.me/?text=${encodedMessage}`, '_blank');
    }
    
    showToast('üì± Payment reminder ready to share');
  }
  
  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 m-3 alert alert-info';
    toast.style.zIndex = '1050';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }
</script>
{% endblock %}