{% extends "base.html" %}

{% block title %}üí∞ Invoices{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">üí∞ Invoices</h1>
  <div class="title-nav-buttons">
    <a href="/invoices/clients" class="btn-base btn-outline-accent btn-sm">üë• Clients</a>
    <a href="/invoices/create" class="btn-base btn-accent btn-sm">‚ûï Create Invoice</a>
  </div>
</div>

<!-- Financial Summary -->
<div class="summary-grid mb-4">
  <div class="summary-card" style="background: linear-gradient(135deg, var(--warning), #e67e22); color: white;">
    <div class="summary-amount">¬£{{ "%.0f"|format(total_unpaid) }}</div>
    <div class="summary-label">Outstanding</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: white;">
    <div class="summary-amount">¬£{{ "%.0f"|format(total_paid) }}</div>
    <div class="summary-label">Received</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--danger), #c0392b); color: white;">
    <div class="summary-amount">{{ num_overdue }}</div>
    <div class="summary-label">Overdue</div>
  </div>
</div>



<!-- Unpaid Invoices -->
{% if unpaid_invoices %}
<div class="card-base mb-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">üí∏ Unpaid ({{ unpaid_invoices|length }})</h5>
    <button class="btn-base btn-outline-secondary btn-sm" onclick="toggleSection('unpaid')">
      <span id="unpaidToggle">‚àí</span>
    </button>
  </div>
  
  <div id="unpaidList" class="invoice-list">
    {% for invoice in unpaid_invoices %}
    <div class="invoice-item" data-status="{{ invoice.status }}">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="flex-grow-1">
          <div class="invoice-client">{{ invoice.client_name }}</div>
          <div class="invoice-description">{{ invoice.description[:40] }}{% if invoice.description|length > 40 %}...{% endif %}</div>
          <div class="invoice-meta">
            <span class="invoice-number">{{ invoice.invoice_number }}</span>
            <span class="invoice-due">Due {{ invoice.due_date }}</span>
            <span class="badge-compact {% if invoice.status == 'overdue' %}badge-danger{% else %}badge-warning{% endif %}">
              {{ invoice.status|upper }}
            </span>
          </div>
        </div>
        <div class="text-end">
          <div class="invoice-amount">¬£{{ "%.0f"|format(invoice.amount) }}</div>
        </div>
      </div>
      
      <div class="d-flex gap-1 flex-wrap">
        <form action="/invoices/mark-paid/{{ invoice.id }}" method="POST" class="d-inline">
          <button type="submit" class="btn-base btn-success btn-xs">‚úÖ Paid</button>
        </form>
        <button onclick="shareInvoice('{{ invoice.id }}')" class="btn-base btn-outline-accent btn-xs">üì±</button>
        <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-secondary btn-xs">üëÅÔ∏è</a>
      </div>
      
      <!-- Hidden sharing data -->
      <div class="invoice-data" id="invoice-{{ invoice.id }}" style="display: none;">
üéæ INVOICE {{ invoice.invoice_number }}

From: {{ current_user.username|title }} (Tennis Coach)
To: {{ invoice.client_name }}
Service: {{ invoice.description }}
Amount: ¬£{{ "%.2f"|format(invoice.amount) }}
Due: {{ invoice.due_date }}
Status: {{ invoice.status.upper() }}

Thank you!
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Paid Invoices -->
{% if paid_invoices %}
<div class="card-base mb-3">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">‚úÖ Paid ({{ paid_invoices|length }})</h5>
    <button class="btn-base btn-outline-secondary btn-sm" onclick="toggleSection('paid')">
      <span id="paidToggle">+</span>
    </button>
  </div>
  
  <div id="paidList" class="invoice-list" style="display: none;">
    {% for invoice in paid_invoices %}
    <div class="invoice-item paid" data-status="{{ invoice.status }}">
      <div class="d-flex justify-content-between align-items-start mb-2">
        <div class="flex-grow-1">
          <div class="invoice-client">{{ invoice.client_name }}</div>
          <div class="invoice-description">{{ invoice.description[:40] }}{% if invoice.description|length > 40 %}...{% endif %}</div>
          <div class="invoice-meta">
            <span class="invoice-number">{{ invoice.invoice_number }}</span>
            <span class="invoice-paid">Paid {{ invoice.paid_date if invoice.paid_date else "?" }}</span>
            <span class="badge-compact badge-success">PAID</span>
          </div>
        </div>
        <div class="text-end">
          <div class="invoice-amount paid">¬£{{ "%.0f"|format(invoice.amount) }}</div>
        </div>
      </div>
      
      <div class="d-flex gap-1">
        <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-accent btn-xs">üëÅÔ∏è</a>
        <a href="/invoices/duplicate/{{ invoice.id }}" class="btn-base btn-outline-secondary btn-xs">üîÑ</a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Empty State -->
{% if not unpaid_invoices and not paid_invoices %}
<div class="card-base text-center p-4">
  <div class="empty-state">
    <div class="empty-icon">üí∞</div>
    <h5 class="mb-2">No Invoices Yet</h5>
    <p class="text-muted mb-3">Create your first invoice to start tracking payments</p>
    <a href="/invoices/create" class="btn-base btn-accent">Create First Invoice</a>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
  /* Streamlined Invoice Items */
  .invoice-list {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .invoice-item {
    background: var(--light);
    border-radius: 8px;
    padding: 12px;
    border-left: 3px solid var(--warning);
    transition: transform 0.2s ease;
  }
  
  .invoice-item.paid {
    border-left-color: var(--success);
  }
  
  .invoice-item:hover {
    transform: translateX(3px);
  }
  
  .invoice-client {
    font-weight: 600;
    color: var(--navy);
    font-size: 0.9rem;
    margin-bottom: 4px;
  }
  
  .invoice-description {
    font-size: 0.8rem;
    color: var(--text-secondary);
    margin-bottom: 6px;
  }
  
  .invoice-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    flex-wrap: wrap;
    font-size: 0.75rem;
    color: var(--text-secondary);
  }
  
  .invoice-amount {
    font-weight: 700;
    color: var(--warning);
    font-size: 1rem;
  }
  
  .invoice-amount.paid {
    color: var(--success);
  }
  
  .badge-compact {
    padding: 2px 6px;
    border-radius: 12px;
    font-size: 0.65rem;
    font-weight: 600;
    text-transform: uppercase;
  }
  
  .badge-warning {
    background: rgba(247, 201, 72, 0.2);
    color: var(--warning);
  }
  
  .badge-success {
    background: rgba(0, 160, 126, 0.2);
    color: var(--success);
  }
  
  .badge-danger {
    background: rgba(231, 76, 60, 0.2);
    color: var(--danger);
  }
  
  .btn-xs {
    padding: 4px 8px;
    font-size: 0.75rem;
    border-radius: 4px;
  }
  
  /* Mobile optimizations */
  @media (max-width: 576px) {
    .summary-grid {
      grid-template-columns: 1fr;
      gap: 8px;
    }
    
    .summary-card {
      padding: 12px;
    }
    
    .summary-amount {
      font-size: 1.3rem;
    }
    
    .invoice-item {
      padding: 10px;
    }
    
    .btn-xs {
      padding: 3px 6px;
      font-size: 0.7rem;
    }
    
    .invoice-meta {
      font-size: 0.7rem;
    }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  // Toggle section visibility
  function toggleSection(section) {
    const list = document.getElementById(section + 'List');
    const toggle = document.getElementById(section + 'Toggle');
    
    if (list.style.display === 'none') {
      list.style.display = 'block';
      toggle.textContent = '‚àí';
    } else {
      list.style.display = 'none';
      toggle.textContent = '+';
    }
  }
  
  // Search functionality
  document.getElementById('searchInput')?.addEventListener('input', function() {
    const term = this.value.toLowerCase();
    const invoices = document.querySelectorAll('.invoice-item');
    
    invoices.forEach(invoice => {
      const text = invoice.textContent.toLowerCase();
      invoice.style.display = text.includes(term) ? 'block' : 'none';
    });
  });
  
  // Status filter
  document.getElementById('statusFilter')?.addEventListener('change', function() {
    const status = this.value;
    const invoices = document.querySelectorAll('.invoice-item');
    
    invoices.forEach(invoice => {
      if (status === 'all' || invoice.dataset.status === status) {
        invoice.style.display = 'block';
      } else {
        invoice.style.display = 'none';
      }
    });
  });
  
  // Share invoice
  function shareInvoice(invoiceId) {
    const invoiceData = document.getElementById(`invoice-${invoiceId}`);
    if (!invoiceData) return;
    
    const text = invoiceData.textContent.trim();
    
    if (navigator.share) {
      navigator.share({
        title: 'Invoice',
        text: text
      });
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('‚úÖ Copied to clipboard!');
      });
    } else {
      const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
      window.open(whatsappUrl, '_blank');
    }
  }
  
  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'position-fixed bottom-0 end-0 m-3 alert alert-success';
    toast.style.zIndex = '1050';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
  }
  
  // Initialize - hide paid section by default
  document.addEventListener('DOMContentLoaded', function() {
    const paidList = document.getElementById('paidList');
    if (paidList) {
      paidList.style.display = 'none';
    }
  });
</script>
{% endblock %}