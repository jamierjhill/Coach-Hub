{% extends "base.html" %}

{% block title %}💰 Invoices{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">💰 Invoices</h1>
  <div class="title-nav-buttons">
    <a href="/invoices/clients" class="btn-base btn-outline-accent">👥 Clients</a>
    <a href="/invoices/create" class="btn-base btn-accent">➕ Create Invoice</a>
  </div>
</div>

<!-- Financial Summary -->
<div class="summary-grid">
  <div class="summary-card" style="background: linear-gradient(135deg, var(--warning), #e67e22); color: white;">
    <div class="summary-amount">£{{ "%.0f"|format(total_unpaid) }}</div>
    <div class="summary-label">Outstanding</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: white;">
    <div class="summary-amount">£{{ "%.0f"|format(total_paid) }}</div>
    <div class="summary-label">Received</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--danger), #c0392b); color: white;">
    <div class="summary-amount">{{ num_overdue }}</div>
    <div class="summary-label">Overdue</div>
  </div>
</div>

<!-- Search and Filter Controls -->
<div class="card-base">
  <div class="row g-3 align-items-end">
    <div class="col-md-6">
      <label class="form-label">Search Invoices</label>
      <input type="text" id="searchInput" class="input-base" placeholder="Search by client name, invoice number, or description...">
    </div>
    <div class="col-md-4">
      <label class="form-label">Filter by Status</label>
      <select id="statusFilter" class="input-base">
        <option value="all">All Invoices</option>
        <option value="unpaid">Unpaid Only</option>
        <option value="overdue">Overdue Only</option>
        <option value="paid">Paid Only</option>
      </select>
    </div>
    <div class="col-md-2">
      <button onclick="clearFilters()" class="btn-base btn-outline-secondary w-100">Clear</button>
    </div>
  </div>
</div>

<!-- Unpaid Invoices Section -->
{% if unpaid_invoices %}
<div class="card-base">
  <div class="flex flex-between align-items-center mb-3">
    <h4 class="section-title mb-0">💸 Unpaid Invoices ({{ unpaid_invoices|length }})</h4>
    <button class="btn-base btn-outline-secondary btn-sm" onclick="toggleSection('unpaid')">
      <span id="unpaidToggle">−</span>
    </button>
  </div>
  
  <div id="unpaidList" class="invoice-list">
    {% for invoice in unpaid_invoices %}
    <div class="card-border-left hover-subtle invoice-item" 
         data-status="{{ invoice.status }}" 
         data-search="{{ (invoice.client_name + ' ' + invoice.invoice_number + ' ' + invoice.description)|lower }}"
         style="border-left-color: {% if invoice.status == 'overdue' %}var(--danger){% else %}var(--warning){% endif %};">
      
      <div class="flex flex-between align-items-start mb-2">
        <div class="flex-grow-1">
          <div class="flex align-items-center gap-2 mb-1">
            <h6 class="mb-0 font-medium">{{ invoice.client_name }}</h6>
            <span class="badge-base {% if invoice.status == 'overdue' %}status-danger{% else %}status-warning{% endif %}">
              {{ invoice.status.upper() }}
            </span>
          </div>
          <div class="text-sm text-muted mb-1">{{ invoice.description }}</div>
          <div class="text-xs text-muted">
            <span class="font-medium">{{ invoice.invoice_number }}</span> • 
            Due {{ invoice.due_date }}
          </div>
        </div>
        <div class="text-end">
          <div class="h5 mb-1 font-bold" style="color: {% if invoice.status == 'overdue' %}var(--danger){% else %}var(--warning){% endif %};">
            £{{ "%.0f"|format(invoice.amount) }}
          </div>
        </div>
      </div>
      
      <div class="flex gap-2 flex-wrap">
        <form action="/invoices/mark-paid/{{ invoice.id }}" method="POST" class="d-inline">
          <button type="submit" class="btn-base btn-success btn-sm">✅ Mark Paid</button>
        </form>
        <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-accent btn-sm">👁️ View</a>
        <button onclick="shareInvoice('{{ invoice.id }}')" class="btn-base btn-outline-secondary btn-sm">📱 Share</button>
      </div>
      
      <!-- Hidden sharing data -->
      <div class="invoice-data" id="invoice-{{ invoice.id }}" style="display: none;">
🎾 INVOICE {{ invoice.invoice_number }}

From: {{ current_user.username|title }} (Tennis Coach)
To: {{ invoice.client_name }}
Service: {{ invoice.description }}
Amount: £{{ "%.2f"|format(invoice.amount) }}
Due: {{ invoice.due_date }}
Status: {{ invoice.status.upper() }}

Thank you!
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Paid Invoices Section -->
{% if paid_invoices %}
<div class="card-base">
  <div class="flex flex-between align-items-center mb-3">
    <h4 class="section-title mb-0">✅ Paid Invoices ({{ paid_invoices|length }})</h4>
    <button class="btn-base btn-outline-secondary btn-sm" onclick="toggleSection('paid')">
      <span id="paidToggle">+</span>
    </button>
  </div>
  
  <div id="paidList" class="invoice-list" style="display: none;">
    {% for invoice in paid_invoices %}
    <div class="card-border-left hover-subtle invoice-item" 
         data-status="{{ invoice.status }}"
         data-search="{{ (invoice.client_name + ' ' + invoice.invoice_number + ' ' + invoice.description)|lower }}"
         style="border-left-color: var(--success);">
      
      <div class="flex flex-between align-items-start mb-2">
        <div class="flex-grow-1">
          <div class="flex align-items-center gap-2 mb-1">
            <h6 class="mb-0 font-medium">{{ invoice.client_name }}</h6>
            <span class="badge-base status-success">PAID</span>
          </div>
          <div class="text-sm text-muted mb-1">{{ invoice.description }}</div>
          <div class="text-xs text-muted">
            <span class="font-medium">{{ invoice.invoice_number }}</span> • 
            Paid {{ invoice.paid_date if invoice.paid_date else "?" }}
          </div>
        </div>
        <div class="text-end">
          <div class="h5 mb-1 font-bold" style="color: var(--success);">
            £{{ "%.0f"|format(invoice.amount) }}
          </div>
        </div>
      </div>
      
      <div class="flex gap-2 flex-wrap">
        <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-accent btn-sm">👁️ View</a>
        <a href="/invoices/duplicate/{{ invoice.id }}" class="btn-base btn-outline-secondary btn-sm">🔄 Duplicate</a>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Empty State -->
{% if not unpaid_invoices and not paid_invoices %}
<div class="card-base">
  <div class="empty-state">
    <div class="empty-icon">💰</div>
    <h4 class="mb-2">No Invoices Yet</h4>
    <p class="text-muted mb-4">Create your first invoice to start tracking payments and managing your tennis coaching business.</p>
    
    <div class="row g-3 justify-content-center">
      <div class="col-auto">
        <a href="/invoices/create" class="btn-base btn-accent">Create First Invoice</a>
      </div>
      <div class="col-auto">
        <a href="/invoices/templates" class="btn-base btn-outline-accent">Set Up Templates</a>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Results Counter -->
<div id="resultsCounter" class="card-base text-center" style="display: none;">
  <div class="text-muted">
    <span id="visibleCount">0</span> of <span id="totalCount">{{ (unpaid_invoices|length + paid_invoices|length) }}</span> invoices shown
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Initialize variables
  let allInvoiceItems = [];
  
  document.addEventListener('DOMContentLoaded', function() {
    allInvoiceItems = Array.from(document.querySelectorAll('.invoice-item'));
    updateResultsCounter();
    
    // Initialize paid section as collapsed by default
    const paidList = document.getElementById('paidList');
    if (paidList) {
      paidList.style.display = 'none';
    }
  });
  
  // Toggle section visibility
  function toggleSection(section) {
    const list = document.getElementById(section + 'List');
    const toggle = document.getElementById(section + 'Toggle');
    
    if (list.style.display === 'none') {
      list.style.display = 'block';
      toggle.textContent = '−';
    } else {
      list.style.display = 'none';
      toggle.textContent = '+';
    }
    updateResultsCounter();
  }
  
  // Search and filter functionality
  document.getElementById('searchInput')?.addEventListener('input', performSearch);
  document.getElementById('statusFilter')?.addEventListener('change', performSearch);
  
  function performSearch() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
    const statusFilter = document.getElementById('statusFilter')?.value || 'all';
    
    let visibleCount = 0;
    
    allInvoiceItems.forEach(item => {
      const searchContent = item.dataset.search || '';
      const status = item.dataset.status || '';
      
      const matchesSearch = !searchTerm || searchContent.includes(searchTerm);
      const matchesFilter = statusFilter === 'all' || status === statusFilter;
      
      const shouldShow = matchesSearch && matchesFilter;
      item.style.display = shouldShow ? 'block' : 'none';
      
      if (shouldShow && item.offsetParent !== null) { // visible
        visibleCount++;
      }
    });
    
    updateResultsCounter();
  }
  
  function clearFilters() {
    const search = document.getElementById('searchInput');
    const filter = document.getElementById('statusFilter');
    
    if (search) search.value = '';
    if (filter) filter.value = 'all';
    
    allInvoiceItems.forEach(item => {
      item.style.display = 'block';
    });
    
    updateResultsCounter();
  }
  
  function updateResultsCounter() {
    const counter = document.getElementById('resultsCounter');
    const visibleCountEl = document.getElementById('visibleCount');
    const totalCountEl = document.getElementById('totalCount');
    
    if (!counter) return;
    
    const visibleItems = allInvoiceItems.filter(item => 
      item.style.display !== 'none' && item.offsetParent !== null
    );
    
    visibleCountEl.textContent = visibleItems.length;
    totalCountEl.textContent = allInvoiceItems.length;
    
    // Show counter only when filtering
    const hasFilters = document.getElementById('searchInput')?.value || 
                      document.getElementById('statusFilter')?.value !== 'all';
    counter.style.display = hasFilters ? 'block' : 'none';
  }
  
  // Share invoice
  function shareInvoice(invoiceId) {
    const invoiceData = document.getElementById(`invoice-${invoiceId}`);
    if (!invoiceData) {
      showToast('❌ Invoice data not found', 'danger');
      return;
    }
    
    const text = invoiceData.textContent.trim();
    
    if (navigator.share) {
      navigator.share({
        title: 'Invoice',
        text: text
      }).catch(err => console.log('Share failed:', err));
    } else if (navigator.clipboard) {
      navigator.clipboard.writeText(text).then(() => {
        showToast('✅ Invoice copied to clipboard!', 'success');
      }).catch(() => {
        fallbackShare(text);
      });
    } else {
      fallbackShare(text);
    }
  }
  
  function fallbackShare(text) {
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
    showToast('📱 Opening WhatsApp...', 'info');
  }
  
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} alert-dismissible fade show animate-fade-in position-fixed`;
    toast.style.cssText = `
      top: 20px;
      right: 20px;
      z-index: 1050;
      max-width: 350px;
      box-shadow: 0 4px 12px rgba(0, 34, 62, 0.15);
    `;
    
    toast.innerHTML = `
      ${message}
      <button type="button" class="btn-close" onclick="this.parentElement.remove()" aria-label="Close"></button>
    `;
    
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
      if (toast.parentNode) {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentNode) {
            toast.remove();
          }
        }, 300);
      }
    }, 4000);
  }
</script>
{% endblock %}