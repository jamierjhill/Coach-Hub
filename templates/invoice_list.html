{% extends "base.html" %}

{% block title %}💰 Invoices{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">💰 Invoices</h1>
  <div class="title-nav-buttons">
    <a href="/invoices/clients" class="btn-base btn-outline-accent">👥 Clients</a>
    <a href="/invoices/create" class="btn-base btn-accent">➕ Create</a>
  </div>
</div>

<!-- Financial Summary - Mobile Optimized -->
<div class="summary-grid">
  <div class="summary-card" style="background: linear-gradient(135deg, var(--warning), #e67e22); color: white;">
    <div class="summary-amount">£{{ "%.0f"|format(total_unpaid) }}</div>
    <div class="summary-label">Outstanding</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--teal), var(--teal-dark)); color: white;">
    <div class="summary-amount">£{{ "%.0f"|format(total_paid) }}</div>
    <div class="summary-label">Received</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--danger), #c0392b); color: white;">
    <div class="summary-amount">{{ num_overdue }}</div>
    <div class="summary-label">Overdue</div>
  </div>
</div>

<!-- Quick Actions - Mobile First -->
<div class="card-base">
  <div class="d-flex flex-column flex-md-row gap-3 align-items-stretch">
    <div class="flex-grow-1">
      <input type="text" id="searchInput" class="input-base" 
             placeholder="Search invoices..."
             style="width: 100%;">
    </div>
    <div class="d-flex gap-2">
      <select id="statusFilter" class="input-base" style="min-width: 120px;">
        <option value="all">All Status</option>
        <option value="unpaid">Unpaid</option>
        <option value="overdue">Overdue</option>
        <option value="paid">Paid</option>
      </select>
      <button onclick="clearFilters()" class="btn-base btn-outline-secondary">Clear</button>
    </div>
  </div>
</div>

<!-- Unpaid Invoices Section -->
{% if unpaid_invoices %}
<div class="card-base">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="section-title mb-0">
      💸 Unpaid ({{ unpaid_invoices|length }})
      {% if num_overdue > 0 %}
        <span class="badge-base status-danger">{{ num_overdue }} overdue</span>
      {% endif %}
    </h4>
    <button class="btn-base btn-outline-secondary btn-sm" onclick="toggleSection('unpaid')">
      <span id="unpaidToggle">−</span>
    </button>
  </div>
  
  <div id="unpaidList" class="invoice-list">
    {% for invoice in unpaid_invoices %}
    <div class="invoice-item" 
         data-status="{{ invoice.status }}" 
         data-search="{{ (invoice.client_name + ' ' + invoice.invoice_number + ' ' + invoice.description)|lower }}">
      
      <!-- Mobile-First Card Layout -->
      <div class="card-border-left hover-subtle" 
           style="border-left-color: {% if invoice.status == 'overdue' %}var(--danger){% else %}var(--warning){% endif %};">
        
        <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
          <!-- Main Content -->
          <div class="flex-grow-1">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start gap-2 mb-2">
              <div>
                <h6 class="mb-1 font-medium">{{ invoice.client_name }}</h6>
                <div class="text-sm text-muted mb-1">{{ invoice.description }}</div>
                <div class="text-xs text-muted">
                  <span class="font-medium">{{ invoice.invoice_number }}</span> • 
                  Due {{ invoice.due_date }}
                  {% if invoice.client_email and invoice.email_sent %}
                  • <span class="text-info">📧</span>
                  {% endif %}
                </div>
              </div>
              
              <!-- Amount and Status -->
              <div class="text-end">
                <div class="h5 mb-1 font-bold" 
                     style="color: {% if invoice.status == 'overdue' %}var(--danger){% else %}var(--warning){% endif %};">
                  £{{ "%.0f"|format(invoice.amount) }}
                </div>
                <span class="badge-base {% if invoice.status == 'overdue' %}status-danger{% else %}status-warning{% endif %} text-xs">
                  {{ invoice.status.upper() }}
                </span>
              </div>
            </div>
            
            <!-- Action Buttons - Mobile Optimized -->
            <div class="d-flex flex-wrap gap-2">
              <form action="/invoices/mark-paid/{{ invoice.id }}" method="POST" class="d-inline">
                <button type="submit" class="btn-base btn-success btn-sm">✅ Paid</button>
              </form>
              <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-accent btn-sm">👁️ View</a>
              <button onclick="quickShare('{{ invoice.id }}')" class="btn-base btn-outline-secondary btn-sm">📱</button>
              {% if invoice.client_email %}
              <button onclick="quickEmail('{{ invoice.id }}')" class="btn-base btn-info btn-sm">📧</button>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Hidden sharing data -->
        <div class="invoice-data" id="invoice-{{ invoice.id }}" style="display: none;">
🎾 INVOICE {{ invoice.invoice_number }}

From: {{ current_user.username|title }} (Tennis Coach)
To: {{ invoice.client_name }}
Service: {{ invoice.description }}
Amount: £{{ "%.2f"|format(invoice.amount) }}
Due: {{ invoice.due_date }}
Status: {{ invoice.status.upper() }}

Thank you!
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Paid Invoices Section - Collapsed by Default -->
{% if paid_invoices %}
<div class="card-base">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="section-title mb-0">✅ Paid ({{ paid_invoices|length }})</h4>
    <button class="btn-base btn-outline-secondary btn-sm" onclick="toggleSection('paid')">
      <span id="paidToggle">+</span>
    </button>
  </div>
  
  <div id="paidList" class="invoice-list" style="display: none;">
    {% for invoice in paid_invoices %}
    <div class="invoice-item" 
         data-status="{{ invoice.status }}"
         data-search="{{ (invoice.client_name + ' ' + invoice.invoice_number + ' ' + invoice.description)|lower }}">
      
      <div class="card-border-left hover-subtle" style="border-left-color: var(--success);">
        <div class="d-flex flex-column flex-md-row justify-content-between gap-2">
          <div class="flex-grow-1">
            <div class="d-flex flex-column flex-sm-row justify-content-between align-items-start gap-2 mb-2">
              <div>
                <h6 class="mb-1 font-medium">{{ invoice.client_name }}</h6>
                <div class="text-sm text-muted mb-1">{{ invoice.description }}</div>
                <div class="text-xs text-muted">
                  <span class="font-medium">{{ invoice.invoice_number }}</span> • 
                  Paid {{ invoice.paid_date if invoice.paid_date else "?" }}
                </div>
              </div>
              
              <div class="text-end">
                <div class="h5 mb-1 font-bold text-success">
                  £{{ "%.0f"|format(invoice.amount) }}
                </div>
                <span class="badge-base status-success text-xs">PAID</span>
              </div>
            </div>
            
            <div class="d-flex flex-wrap gap-2">
              <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-accent btn-sm">👁️ View</a>
              <a href="/invoices/duplicate/{{ invoice.id }}" class="btn-base btn-outline-secondary btn-sm">🔄 Copy</a>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Empty State -->
{% if not unpaid_invoices and not paid_invoices %}
<div class="card-base">
  <div class="empty-state">
    <div class="empty-icon">💰</div>
    <h4 class="mb-2">No Invoices Yet</h4>
    <p class="text-muted mb-4">Create your first invoice to start tracking payments and managing your tennis coaching business.</p>
    
    <!-- Mobile-Optimized Empty State Actions -->
    <div class="d-flex flex-column flex-sm-row gap-3 justify-content-center">
      <a href="/invoices/create" class="btn-base btn-accent">Create First Invoice</a>
      <a href="/invoices/templates" class="btn-base btn-outline-accent">Set Up Templates</a>
    </div>
    
    <!-- Quick Tips for New Users -->
    <div class="mt-4 p-3" style="background: rgba(0, 160, 126, 0.05); border-radius: 8px;">
      <h6 class="text-center mb-2">💡 Quick Start Tips</h6>
      <div class="text-sm text-muted">
        <p>• Create templates for common services to speed up invoice creation</p>
        <p>• Add client email addresses to send invoices automatically</p>
        <p>• Use the sharing features to send invoices via WhatsApp or copy to clipboard</p>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- Results Counter -->
<div id="resultsCounter" class="text-center mt-3" style="display: none;">
  <div class="text-muted small">
    Showing <span id="visibleCount">0</span> of <span id="totalCount">{{ (unpaid_invoices|length + paid_invoices|length) }}</span> invoices
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Initialize variables
  let allInvoiceItems = [];
  
  document.addEventListener('DOMContentLoaded', function() {
    allInvoiceItems = Array.from(document.querySelectorAll('.invoice-item'));
    updateResultsCounter();
    
    // Initialize search and filter
    document.getElementById('searchInput')?.addEventListener('input', performSearch);
    document.getElementById('statusFilter')?.addEventListener('change', performSearch);
    
    // Mobile optimizations
    if (window.innerWidth <= 768) {
      optimizeForMobile();
    }
  });
  
  // Mobile-specific optimizations
  function optimizeForMobile() {
    // Optimize button sizes for touch
    const buttons = document.querySelectorAll('.btn-sm');
    buttons.forEach(btn => {
      btn.style.minHeight = '36px';
      btn.style.padding = '0.375rem 0.75rem';
    });
    
    // Optimize search input for mobile
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
      searchInput.style.fontSize = '16px'; // Prevent zoom on iOS
    }
  }
  
  // Toggle section visibility
  function toggleSection(section) {
    const list = document.getElementById(section + 'List');
    const toggle = document.getElementById(section + 'Toggle');
    
    if (list.style.display === 'none') {
      list.style.display = 'block';
      toggle.textContent = '−';
    } else {
      list.style.display = 'none';
      toggle.textContent = '+';
    }
    updateResultsCounter();
  }
  
  // Search and filter functionality
  function performSearch() {
    const searchTerm = document.getElementById('searchInput')?.value.toLowerCase().trim() || '';
    const statusFilter = document.getElementById('statusFilter')?.value || 'all';
    
    let visibleCount = 0;
    
    allInvoiceItems.forEach(item => {
      const searchContent = item.dataset.search || '';
      const status = item.dataset.status || '';
      
      const matchesSearch = !searchTerm || searchContent.includes(searchTerm);
      const matchesFilter = statusFilter === 'all' || status === statusFilter;
      
      const shouldShow = matchesSearch && matchesFilter;
      item.style.display = shouldShow ? 'block' : 'none';
      
      if (shouldShow && item.offsetParent !== null) {
        visibleCount++;
      }
    });
    
    updateResultsCounter();
    
    // Show results counter when filtering
    const hasFilters = searchTerm || statusFilter !== 'all';
    document.getElementById('resultsCounter').style.display = hasFilters ? 'block' : 'none';
  }
  
  function clearFilters() {
    const search = document.getElementById('searchInput');
    const filter = document.getElementById('statusFilter');
    
    if (search) search.value = '';
    if (filter) filter.value = 'all';
    
    allInvoiceItems.forEach(item => {
      item.style.display = 'block';
    });
    
    document.getElementById('resultsCounter').style.display = 'none';
    updateResultsCounter();
  }
  
  function updateResultsCounter() {
    const visibleCountEl = document.getElementById('visibleCount');
    const totalCountEl = document.getElementById('totalCount');
    
    if (!visibleCountEl || !totalCountEl) return;
    
    const visibleItems = allInvoiceItems.filter(item => 
      item.style.display !== 'none' && item.offsetParent !== null
    );
    
    visibleCountEl.textContent = visibleItems.length;
    totalCountEl.textContent = allInvoiceItems.length;
  }
  
  // Quick share invoice
  function quickShare(invoiceId) {
    const invoiceData = document.getElementById(`invoice-${invoiceId}`);
    if (!invoiceData) {
      showToast('❌ Invoice data not found', 'danger');
      return;
    }
    
    const text = invoiceData.textContent.trim();
    
    // Try native share first (mobile)
    if (navigator.share) {
      navigator.share({
        title: 'Invoice',
        text: text
      }).catch(err => {
        // Fallback to WhatsApp
        fallbackShare(text);
      });
    } else if (navigator.clipboard) {
      // Desktop: copy to clipboard
      navigator.clipboard.writeText(text).then(() => {
        showToast('✅ Invoice copied to clipboard!', 'success');
      }).catch(() => {
        fallbackShare(text);
      });
    } else {
      fallbackShare(text);
    }
  }
  
  // Quick email invoice
  function quickEmail(invoiceId) {
    fetch(`/invoices/send-email/${invoiceId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        showToast('📧 Email sent successfully!', 'success');
        
        // Update UI to show email sent
        const invoiceItem = document.querySelector(`[data-search*="${invoiceId}"]`);
        if (invoiceItem) {
          const emailIcon = invoiceItem.querySelector('.text-xs');
          if (emailIcon && !emailIcon.textContent.includes('📧')) {
            emailIcon.innerHTML += ' • <span class="text-info">📧</span>';
          }
        }
      } else {
        showToast(`❌ Email failed: ${data.error}`, 'danger');
      }
    })
    .catch(error => {
      console.error('Error:', error);
      showToast('❌ Failed to send email', 'danger');
    });
  }
  
  function fallbackShare(text) {
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(text)}`;
    window.open(whatsappUrl, '_blank');
    showToast('📱 Opening WhatsApp...', 'info');
  }
  
  // Mobile-optimized toast notifications
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 start-50 translate-middle-x mt-3`;
    toast.style.cssText = `
      background: ${type === 'success' ? 'var(--success)' : type === 'danger' ? 'var(--danger)' : 'var(--info)'};
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      z-index: 1050;
      font-size: 0.875rem;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideDown 0.3s ease;
    `;
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
      toast.style.animation = 'slideUp 0.3s ease';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 3000);
  }
  
  // Auto-refresh unpaid invoices status periodically (optional)
  function checkForOverdueInvoices() {
    const today = new Date().toISOString().split('T')[0];
    const unpaidItems = document.querySelectorAll('.invoice-item[data-status="unpaid"]');
    
    unpaidItems.forEach(item => {
      const dueDateText = item.querySelector('.text-xs').textContent;
      const dueDateMatch = dueDateText.match(/Due (\d{4}-\d{2}-\d{2})/);
      
      if (dueDateMatch && dueDateMatch[1] < today) {
        // Mark as overdue visually
        item.dataset.status = 'overdue';
        const badge = item.querySelector('.badge-base');
        const amount = item.querySelector('.h5');
        const borderCard = item.querySelector('.card-border-left');
        
        if (badge) {
          badge.className = badge.className.replace('status-warning', 'status-danger');
          badge.textContent = 'OVERDUE';
        }
        if (amount) {
          amount.style.color = 'var(--danger)';
        }
        if (borderCard) {
          borderCard.style.borderLeftColor = 'var(--danger)';
        }
      }
    });
  }
  
  // Check for overdue invoices on page load
  setTimeout(checkForOverdueInvoices, 1000);
</script>

<style>
@keyframes slideDown {
  from { transform: translate(-50%, -100%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

@keyframes slideUp {
  from { transform: translate(-50%, 0); opacity: 1; }
  to { transform: translate(-50%, -100%); opacity: 0; }
}

/* Mobile-specific optimizations */
@media (max-width: 768px) {
  .summary-grid {
    grid-template-columns: 1fr;
    gap: 0.75rem;
  }
  
  .summary-card {
    padding: 1rem;
  }
  
  .invoice-item .card-border-left {
    padding: 0.75rem;
    margin-bottom: 0.75rem;
  }
  
  .btn-sm {
    font-size: 0.8rem;
    padding: 0.375rem 0.75rem;
  }
  
  .section-title {
    font-size: 1.1rem;
  }
  
  .d-flex.gap-2 {
    gap: 0.5rem;
  }
  
  .title-nav-buttons {
    flex-direction: column;
    gap: 0.5rem;
  }
  
  .title-nav-buttons .btn-base {
    width: 100%;
  }
}

@media (max-width: 576px) {
  .card-base {
    padding: 1rem;
    margin-bottom: 1rem;
  }
  
  .d-flex.gap-3 {
    gap: 1rem;
  }
  
  .flex-md-row {
    flex-direction: column;
  }
  
  .btn-base {
    font-size: 0.875rem;
  }
}
</style>
{% endblock %}