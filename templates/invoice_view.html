{% extends "base.html" %}

{% block title %}Invoice #{{ invoice.invoice_number }}{% endblock %}

{% block extra_css %}
<style>
  /* Print Optimization */
  @media print {
    .no-print { display: none !important; }
    .card-base { box-shadow: none !important; border: 1px solid #ddd !important; }
    .page-title-container { display: none !important; }
    body { font-size: 12px !important; }
  }
  
  .invoice-header {
    border-bottom: 2px solid var(--light-border);
    padding-bottom: 1.5rem;
    margin-bottom: 1.5rem;
  }
  
  .invoice-amount-display {
    background: linear-gradient(135deg, var(--navy), var(--navy-light));
    color: white;
    padding: 1.5rem;
    border-radius: 12px;
    text-align: center;
    margin: 1.5rem 0;
  }
  
  .status-card {
    padding: 1rem;
    border-radius: 12px;
    margin-bottom: 1rem;
  }
  
  .status-unpaid { background: rgba(247, 201, 72, 0.1); border-left: 4px solid var(--warning); }
  .status-overdue { background: rgba(231, 76, 60, 0.1); border-left: 4px solid var(--danger); }
  .status-paid { background: rgba(0, 160, 126, 0.1); border-left: 4px solid var(--success); }
  
  /* Mobile optimizations */
  @media (max-width: 768px) {
    .invoice-amount-display { padding: 1rem; margin: 1rem 0; }
    .invoice-amount-display .display-4 { font-size: 1.8rem; }
    .action-buttons { gap: 0.5rem; }
    .action-buttons .btn-base { width: 100%; margin-bottom: 0.5rem; }
    .share-section { margin-top: 1rem; }
    .share-section .btn-base { width: 100%; margin-bottom: 0.5rem; }
  }
  
  /* Success animations */
  .success-flash { 
    background: linear-gradient(135deg, var(--success), #059669) !important;
    transform: scale(1.05);
    transition: all 0.3s ease;
  }
  
  .email-sending { 
    background: linear-gradient(135deg, var(--info), #1e88e5) !important;
    transform: scale(1.05);
    transition: all 0.3s ease;
  }
</style>
{% endblock %}

{% block content %}
<div class="page-title-container no-print">
  <h1 class="page-title">Invoice #{{ invoice.invoice_number }}</h1>
  <div class="title-nav-buttons">
    <a href="/invoices" class="btn-base btn-outline-accent">‚Üê Back</a>
    <a href="/invoices/duplicate/{{ invoice.id }}" class="btn-base btn-outline-secondary">üîÑ Duplicate</a>
  </div>
</div>

<div class="container" style="max-width: 800px; margin: 0 auto;">
  
  <!-- Status Card - Mobile First -->
  <div class="status-card status-{{ invoice.status }} no-print">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start gap-3">
      <div>
        <div class="d-flex align-items-center gap-2 mb-2">
          <span class="badge-base status-{{ 'success' if invoice.status == 'paid' else 'warning' if invoice.status == 'unpaid' else 'danger' }} text-lg">
            {{ invoice.status.upper() }}
          </span>
          {% if invoice.client_email and invoice.email_sent %}
            <span class="badge-base status-info text-sm">üìß EMAIL SENT</span>
          {% endif %}
        </div>
        
        {% if invoice.status == "overdue" %}
          <p class="text-danger font-medium mb-0">‚ö†Ô∏è This invoice is overdue</p>
        {% elif invoice.status == "paid" %}
          <p class="text-success font-medium mb-0">‚úÖ Payment received on {{ invoice.paid_date }}</p>
        {% else %}
          <p class="text-muted mb-0">Due: {{ invoice.due_date }}</p>
        {% endif %}
      </div>
      
      <!-- Primary Actions - Mobile Optimized -->
      <div class="action-buttons d-flex flex-column flex-md-row gap-2">
        {% if invoice.status != "paid" %}
          <form action="/invoices/mark-paid/{{ invoice.id }}" method="POST">
            <button type="submit" class="btn-base btn-success">‚úÖ Mark as Paid</button>
          </form>
        {% endif %}
        
        <button onclick="window.print()" class="btn-base btn-outline-accent">üñ®Ô∏è Print</button>
        
        <div class="dropdown">
          <button class="btn-base btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
            ‚öôÔ∏è More
          </button>
          <ul class="dropdown-menu">
            <li><a class="dropdown-item" href="/invoices/duplicate/{{ invoice.id }}">üîÑ Duplicate</a></li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item text-danger" href="#" 
                 onclick="if(confirm('Are you sure you want to delete this invoice?')) { document.getElementById('deleteForm').submit(); }">
                üóëÔ∏è Delete
              </a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Email Actions - Mobile Optimized -->
  {% if invoice.client_email %}
  <div class="card-border-left no-print" style="background-color: rgba(0, 160, 126, 0.05);">
    <h5 class="mb-3">üìß Email Actions</h5>
    <div class="d-flex flex-column flex-md-row gap-2 mb-3">
      <button onclick="sendInvoiceEmail()" id="sendEmailBtn" class="btn-base btn-accent flex-fill">
        <span id="sendEmailText">üì§ Email Invoice</span>
        <span id="emailSpinner" class="spinner-border spinner-border-sm ms-1" style="display: none;"></span>
      </button>
      <button onclick="sendPaymentReminder()" class="btn-base btn-outline-accent flex-fill">
        ‚è∞ Payment Reminder
      </button>
    </div>
    <div class="text-muted text-xs">
      üìß {{ invoice.client_email }}
      {% if invoice.email_sent_date %}
      <br>Last emailed: {{ invoice.email_sent_date }}
      {% endif %}
    </div>
  </div>
  {% endif %}
  
  <!-- Share Options - Mobile Optimized -->
  <div class="card-border-left no-print">
    <h5 class="mb-3">üì§ Share Invoice</h5>
    <div class="share-section d-flex flex-column flex-md-row gap-2">
      <button onclick="shareViaWhatsApp()" class="btn-base btn-accent flex-fill">
        üì± WhatsApp
      </button>
      <button onclick="copyToClipboard()" id="copyBtn" class="btn-base btn-outline-accent flex-fill">
        <span id="copyBtnText">üìã Copy Text</span>
      </button>
      {% if invoice.client_email %}
      <button onclick="shareViaEmail()" class="btn-base btn-outline-secondary flex-fill">
        üìß Email
      </button>
      {% endif %}
    </div>
  </div>
  
  <!-- Invoice Content -->
  <div class="card-base">
    <!-- Invoice Header -->
    <div class="invoice-header">
      <div class="row align-items-start">
        <div class="col-12 col-md-6 mb-3 mb-md-0">
          <h1 class="display-6 mb-2">INVOICE</h1>
          <div class="text-lg font-medium">{{ invoice.invoice_number }}</div>
        </div>
        
        <div class="col-12 col-md-6 text-md-end">
          <div class="mb-2"><strong>Issue Date:</strong> {{ invoice.issue_date }}</div>
          <div class="mb-2"><strong>Due Date:</strong> {{ invoice.due_date }}</div>
          {% if invoice.status == "paid" and invoice.paid_date %}
          <div class="text-success"><strong>Paid Date:</strong> {{ invoice.paid_date }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- From/To Details - Mobile Stacked -->
    <div class="row mb-4">
      <div class="col-12 col-md-6 mb-3 mb-md-0">
        <div class="card-border-left">
          <h6 class="section-title mb-2">FROM</h6>
          <div class="font-medium">{{ invoice.coach_name|default(current_user.username)|title }}</div>
          <div class="text-muted small">Tennis Coach</div>
        </div>
      </div>
      
      <div class="col-12 col-md-6">
        <div class="card-border-left">
          <h6 class="section-title mb-2">TO</h6>
          <div class="font-medium">{{ invoice.client_name }}</div>
          {% if invoice.client_email %}
          <div class="text-muted small">üìß {{ invoice.client_email }}</div>
          {% endif %}
          {% if invoice.payment_method %}
          <div class="text-muted small">üí≥ {{ invoice.payment_method|title }}</div>
          {% endif %}
        </div>
      </div>
    </div>
    
    <!-- Invoice Amount - Mobile Optimized -->
    <div class="invoice-amount-display">
      <div class="small mb-2" style="opacity: 0.8;">TOTAL AMOUNT</div>
      <div class="display-4 font-bold">¬£{{ "%.2f"|format(invoice.total_amount) }}</div>
    </div>
    
    <!-- Service Description -->
    <div class="mb-4">
      <h6 class="section-title">Service Description</h6>
      <div class="card-border-left">
        <p class="mb-0">{{ invoice.description }}</p>
      </div>
    </div>
    
    <!-- Notes -->
    {% if invoice.notes %}
    <div class="mb-4">
      <h6 class="section-title">Notes</h6>
      <div class="card-border-left">
        <p class="mb-0" style="white-space: pre-line;">{{ invoice.notes }}</p>
      </div>
    </div>
    {% endif %}
    
    <!-- Footer -->
    <div class="text-center mt-5 pt-4" style="border-top: 1px solid var(--light-border);">
      <p class="mb-1 font-medium">Thank you for your business!</p>
      <p class="text-muted small">Generated by Coaches Hub</p>
    </div>
  </div>
</div>

<!-- Hidden Forms -->
<form id="deleteForm" action="/invoices/delete/{{ invoice.id }}" method="POST" style="display: none;"></form>

<!-- Hidden invoice text for sharing -->
<div id="invoiceText" style="display: none;">
üéæ INVOICE

Invoice #: {{ invoice.invoice_number }}
From: {{ invoice.coach_name|default(current_user.username)|title }} (Tennis Coach)
To: {{ invoice.client_name }}
{% if invoice.client_email %}Email: {{ invoice.client_email }}{% endif %}

Service: {{ invoice.description }}
Amount: ¬£{{ "%.2f"|format(invoice.total_amount) }}

Issue Date: {{ invoice.issue_date }}
Due Date: {{ invoice.due_date }}
{% if invoice.status == "paid" and invoice.paid_date %}‚úÖ PAID on {{ invoice.paid_date }}{% else %}Status: {{ invoice.status.upper() }}{% endif %}

{% if invoice.payment_method %}Payment Method: {{ invoice.payment_method|title }}{% endif %}
{% if invoice.notes %}

Notes: {{ invoice.notes }}{% endif %}

Thank you for your business!
- Generated by Coaches Hub
</div>

{% endblock %}

{% block extra_js %}
<script>
  // Get the invoice text for sharing
  function getInvoiceText() {
    return document.getElementById('invoiceText').textContent.trim();
  }
  
  // Share via WhatsApp
  function shareViaWhatsApp() {
    const invoiceText = getInvoiceText();
    const encodedText = encodeURIComponent(invoiceText);
    const whatsappUrl = `https://wa.me/?text=${encodedText}`;
    
    window.open(whatsappUrl, '_blank');
    showMobileToast('üì± Opening WhatsApp to share invoice...', 'info');
  }
  
  // Share via Email (opens default email client)
  function shareViaEmail() {
    const invoiceText = getInvoiceText();
    const subject = `Invoice #{{ invoice.invoice_number }} from {{ current_user.username|title }}`;
    const mailto = `mailto:{{ invoice.client_email }}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(invoiceText)}`;
    
    window.location.href = mailto;
    showMobileToast('üìß Opening email client...', 'info');
  }
  
  // Copy to clipboard with mobile optimization
  async function copyToClipboard() {
    const invoiceText = getInvoiceText();
    const copyBtn = document.getElementById('copyBtn');
    const copyBtnText = document.getElementById('copyBtnText');
    
    try {
      await navigator.clipboard.writeText(invoiceText);
      
      // Visual feedback
      copyBtn.classList.add('success-flash');
      copyBtnText.textContent = '‚úÖ Copied!';
      
      showMobileToast('‚úÖ Invoice details copied to clipboard!', 'success');
      
      // Reset button after 2 seconds
      setTimeout(() => {
        copyBtn.classList.remove('success-flash');
        copyBtnText.textContent = 'üìã Copy Text';
      }, 2000);
      
    } catch (err) {
      console.error('Failed to copy: ', err);
      // Fallback for older browsers
      fallbackCopyTextToClipboard(invoiceText);
    }
  }
  
  // Send invoice via email
  function sendInvoiceEmail() {
    const sendBtn = document.getElementById('sendEmailBtn');
    const sendText = document.getElementById('sendEmailText');
    const spinner = document.getElementById('emailSpinner');
    
    // Show loading state
    sendBtn.classList.add('email-sending');
    sendText.textContent = 'Sending...';
    spinner.style.display = 'inline-block';
    sendBtn.disabled = true;
    
    // Make actual API call
    fetch('/invoices/send-email/{{ invoice.id }}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      }
    })
    .then(response => response.json())
    .then(data => {
      // Reset button state
      sendBtn.classList.remove('email-sending');
      spinner.style.display = 'none';
      sendBtn.disabled = false;
      
      if (data.success) {
        sendText.textContent = '‚úÖ Email Sent!';
        showMobileToast('üìß Invoice email sent successfully!', 'success');
        
        // Update email status indicator
        const statusCard = document.querySelector('.status-card');
        if (statusCard && !statusCard.querySelector('.badge-base:contains("EMAIL SENT")')) {
          const emailBadge = document.createElement('span');
          emailBadge.className = 'badge-base status-info text-sm ms-2';
          emailBadge.textContent = 'üìß EMAIL SENT';
          statusCard.querySelector('.d-flex').appendChild(emailBadge);
        }
      } else {
        sendText.textContent = '‚ùå Failed';
        showMobileToast(`‚ùå Email failed: ${data.error}`, 'danger');
      }
      
      // Reset button text after 3 seconds
      setTimeout(() => {
        sendText.textContent = 'üì§ Email Invoice';
      }, 3000);
    })
    .catch(error => {
      console.error('Error:', error);
      sendBtn.classList.remove('email-sending');
      sendText.textContent = '‚ùå Error';
      spinner.style.display = 'none';
      sendBtn.disabled = false;
      showMobileToast('‚ùå Failed to send email. Please try again.', 'danger');
      
      setTimeout(() => {
        sendText.textContent = 'üì§ Email Invoice';
      }, 3000);
    });
  }
  
  // Send payment reminder
  function sendPaymentReminder() {
    const reminderText = `Hi {{ invoice.client_name }},

This is a friendly reminder that invoice #{{ invoice.invoice_number }} for ¬£{{ "%.2f"|format(invoice.total_amount) }} is due on {{ invoice.due_date }}.

{% if invoice.status == 'overdue' %}This invoice is now overdue. {% endif %}If you've already made payment, please ignore this reminder.

Thank you!
{{ current_user.username|title }}`;
    
    const encodedText = encodeURIComponent(reminderText);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
    showMobileToast('üì± Opening WhatsApp with payment reminder...', 'info');
  }
  
  // Mobile-optimized toast notification
  function showMobileToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `position-fixed top-0 start-50 translate-middle-x mt-3`;
    toast.style.cssText = `
      background: ${type === 'success' ? 'var(--success)' : type === 'danger' ? 'var(--danger)' : 'var(--info)'};
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      z-index: 1050;
      font-size: 0.875rem;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideDown 0.3s ease;
    `;
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    // Auto-remove after 4 seconds
    setTimeout(() => {
      toast.style.animation = 'slideUp 0.3s ease';
      setTimeout(() => {
        if (toast.parentNode) {
          toast.parentNode.removeChild(toast);
        }
      }, 300);
    }, 4000);
  }
  
  // Fallback copy method for older browsers
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showMobileToast('‚úÖ Invoice details copied to clipboard!', 'success');
        
        const copyBtn = document.getElementById('copyBtn');
        const copyBtnText = document.getElementById('copyBtnText');
        copyBtn.classList.add('success-flash');
        copyBtnText.textContent = '‚úÖ Copied!';
        
        setTimeout(() => {
          copyBtn.classList.remove('success-flash');
          copyBtnText.textContent = 'üìã Copy Text';
        }, 2000);
      } else {
        showMobileToast('‚ùå Failed to copy. Please try again.', 'danger');
      }
    } catch (err) {
      showMobileToast('‚ùå Copy not supported. Please select and copy manually.', 'warning');
    }
    
    document.body.removeChild(textArea);
  }
  
  // Handle mobile responsiveness
  document.addEventListener('DOMContentLoaded', function() {
    // Mobile-specific optimizations
    if (window.innerWidth <= 768) {
      // Optimize button sizes for touch
      const buttons = document.querySelectorAll('.btn-base');
      buttons.forEach(btn => {
        btn.style.minHeight = '44px';
        btn.style.fontSize = '0.9rem';
      });
      
      // Optimize spacing
      const cards = document.querySelectorAll('.card-base, .card-border-left');
      cards.forEach(card => {
        card.style.marginBottom = '1rem';
      });
    }
    
    // Add keyboard shortcuts for desktop
    document.addEventListener('keydown', function(e) {
      if (window.innerWidth > 768) { // Desktop only
        // Ctrl+C or Cmd+C to copy
        if ((e.ctrlKey || e.metaKey) && e.key === 'c' && !e.target.matches('input, textarea')) {
          e.preventDefault();
          copyToClipboard();
        }
        
        // Ctrl+E or Cmd+E to send email (if email available)
        if ((e.ctrlKey || e.metaKey) && e.key === 'e' && !e.target.matches('input, textarea')) {
          e.preventDefault();
          {% if invoice.client_email %}
          sendInvoiceEmail();
          {% endif %}
        }
      }
    });
  });
</script>

<style>
@keyframes slideDown {
  from { transform: translate(-50%, -100%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

@keyframes slideUp {
  from { transform: translate(-50%, 0); opacity: 1; }
  to { transform: translate(-50%, -100%); opacity: 0; }
}
</style>
{% endblock %}