{% extends "base.html" %}

{% block title %}Invoice #{{ invoice.invoice_number }}{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">Invoice #{{ invoice.invoice_number }}</h1>
  <div class="title-nav-buttons">
    <a href="/invoices" class="btn-base btn-outline-accent">← Back</a>
    <a href="/invoices/duplicate/{{ invoice.id }}" class="btn-base btn-outline-secondary">🔄 Duplicate</a>
  </div>
</div>

<!-- Status Card -->
<div class="card-border-left" style="border-left-color: {{ 'var(--danger)' if invoice.status == 'overdue' else 'var(--warning)' if invoice.status == 'unpaid' else 'var(--success)' }};">
  <div class="flex flex-between align-items-center">
    <div>
      <div class="flex align-items-center mb-2">
        <span class="badge-base status-{{ 'danger' if invoice.status == 'overdue' else 'warning' if invoice.status == 'unpaid' else 'success' }}">
          {{ invoice.status.upper() }}
        </span>
        {% if invoice.client_email and invoice.email_sent %}
          <span class="badge-base status-info ml-2">📧 EMAIL SENT</span>
        {% endif %}
      </div>
      
      {% if invoice.status == "overdue" %}
        <p class="text-danger font-medium mb-0">⚠️ This invoice is overdue</p>
      {% elif invoice.status == "paid" %}
        <p class="text-success font-medium mb-0">✅ Payment received on {{ invoice.paid_date }}</p>
      {% else %}
        <p class="text-muted mb-0">Due: {{ invoice.due_date }}</p>
      {% endif %}
    </div>
    
    <div class="flex flex-wrap" style="gap: 0.5rem;">
      {% if invoice.status != "paid" %}
        <form action="/invoices/mark-paid/{{ invoice.id }}" method="POST">
          <button type="submit" class="btn-base btn-success">✅ Mark as Paid</button>
        </form>
      {% endif %}
      
      <button onclick="window.print()" class="btn-base btn-outline-accent">🖨️ Print</button>
    </div>
  </div>
</div>

<!-- Email Actions -->
{% if invoice.client_email %}
<div class="card-border-left" style="background-color: rgba(0, 160, 126, 0.05);">
  <h5 class="section-title">📧 Email Actions</h5>
  <div class="flex flex-wrap mb-3" style="gap: 0.5rem;">
    <button onclick="sendInvoiceEmail()" id="sendEmailBtn" class="btn-base btn-accent">
      <span id="sendEmailText">📤 Email Invoice</span>
    </button>
    <button onclick="sendPaymentReminder()" class="btn-base btn-outline-accent">
      ⏰ Payment Reminder
    </button>
  </div>
  <div class="text-muted text-sm">
    📧 {{ invoice.client_email }}
    {% if invoice.email_sent_date %}
    <br>Last emailed: {{ invoice.email_sent_date }}
    {% endif %}
  </div>
</div>
{% endif %}

<!-- Share Options -->
<div class="card-border-left">
  <h5 class="section-title">📤 Share Invoice</h5>
  <div class="flex flex-wrap" style="gap: 0.5rem;">
    <button onclick="shareViaWhatsApp()" class="btn-base btn-accent">📱 WhatsApp</button>
    <button onclick="copyToClipboard()" id="copyBtn" class="btn-base btn-outline-accent">
      <span id="copyBtnText">📋 Copy Text</span>
    </button>
    {% if invoice.client_email %}
    <button onclick="shareViaEmail()" class="btn-base btn-outline-secondary">📧 Email</button>
    {% endif %}
  </div>
</div>

<!-- Invoice Content -->
<div class="card-base">
  <!-- Invoice Header -->
  <div class="flex flex-between align-items-start mb-4" style="border-bottom: 2px solid var(--light-border); padding-bottom: 1.5rem;">
    <div>
      <h1 class="text-3xl font-bold mb-2">INVOICE</h1>
      <div class="text-lg font-medium">{{ invoice.invoice_number }}</div>
    </div>
    
    <div class="text-right">
      <div class="mb-2"><strong>Issue Date:</strong> {{ invoice.issue_date }}</div>
      <div class="mb-2"><strong>Due Date:</strong> {{ invoice.due_date }}</div>
      {% if invoice.status == "paid" and invoice.paid_date %}
      <div class="text-success"><strong>Paid Date:</strong> {{ invoice.paid_date }}</div>
      {% endif %}
    </div>
  </div>
  
  <!-- From/To Details -->
  <div class="flex flex-wrap mb-4" style="gap: 2rem;">
    <div style="flex: 1; min-width: 200px;">
      <div class="card-border-left">
        <h6 class="section-title">FROM</h6>
        <div class="font-medium">{{ invoice.coach_name|default(current_user.username)|title }}</div>
        <div class="text-muted text-sm">Tennis Coach</div>
      </div>
    </div>
    
    <div style="flex: 1; min-width: 200px;">
      <div class="card-border-left">
        <h6 class="section-title">TO</h6>
        <div class="font-medium">{{ invoice.client_name }}</div>
        {% if invoice.client_email %}
        <div class="text-muted text-sm">📧 {{ invoice.client_email }}</div>
        {% endif %}
        {% if invoice.payment_method %}
        <div class="text-muted text-sm">💳 {{ invoice.payment_method|title }}</div>
        {% endif %}
      </div>
    </div>
  </div>
  
  <!-- Invoice Amount -->
  <div class="summary-card text-center mb-4" style="background: linear-gradient(135deg, var(--navy), var(--navy-light)); color: white;">
    <div class="text-sm mb-2" style="opacity: 0.8;">TOTAL AMOUNT</div>
    <div class="text-3xl font-bold">£{{ "%.2f"|format(invoice.total_amount) }}</div>
  </div>
  
  <!-- Service Description -->
  <div class="mb-4">
    <h6 class="section-title">Service Description</h6>
    <div class="card-border-left">
      <p class="mb-0">{{ invoice.description }}</p>
    </div>
  </div>
  
  <!-- Notes -->
  {% if invoice.notes %}
  <div class="mb-4">
    <h6 class="section-title">Notes</h6>
    <div class="card-border-left">
      <p class="mb-0" style="white-space: pre-line;">{{ invoice.notes }}</p>
    </div>
  </div>
  {% endif %}
  
  <!-- Footer -->
  <div class="text-center" style="margin-top: 2rem; padding-top: 1rem; border-top: 1px solid var(--light-border);">
    <p class="font-medium mb-1">Thank you for your business!</p>
    <p class="text-muted text-sm">Generated by Coaches Hub</p>
  </div>
</div>

<!-- Hidden Forms -->
<form id="deleteForm" action="/invoices/delete/{{ invoice.id }}" method="POST" style="display: none;"></form>

<!-- Hidden invoice text for sharing -->
<div id="invoiceText" style="display: none;">
🎾 INVOICE

Invoice #: {{ invoice.invoice_number }}
From: {{ invoice.coach_name|default(current_user.username)|title }} (Tennis Coach)
To: {{ invoice.client_name }}
{% if invoice.client_email %}Email: {{ invoice.client_email }}{% endif %}

Service: {{ invoice.description }}
Amount: £{{ "%.2f"|format(invoice.total_amount) }}

Issue Date: {{ invoice.issue_date }}
Due Date: {{ invoice.due_date }}
{% if invoice.status == "paid" and invoice.paid_date %}✅ PAID on {{ invoice.paid_date }}{% else %}Status: {{ invoice.status.upper() }}{% endif %}

{% if invoice.payment_method %}Payment Method: {{ invoice.payment_method|title }}{% endif %}
{% if invoice.notes %}

Notes: {{ invoice.notes }}{% endif %}

Thank you for your business!
- Generated by Coaches Hub
</div>

{% endblock %}

{% block extra_js %}
<script>
  function getInvoiceText() {
    return document.getElementById('invoiceText').textContent.trim();
  }
  
  function shareViaWhatsApp() {
    const invoiceText = getInvoiceText();
    const encodedText = encodeURIComponent(invoiceText);
    const whatsappUrl = `https://wa.me/?text=${encodedText}`;
    
    window.open(whatsappUrl, '_blank');
    showToast('📱 Opening WhatsApp to share invoice...');
  }
  
  function shareViaEmail() {
    const invoiceText = getInvoiceText();
    const subject = `Invoice #{{ invoice.invoice_number }} from {{ current_user.username|title }}`;
    const mailto = `mailto:{{ invoice.client_email }}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(invoiceText)}`;
    
    window.location.href = mailto;
    showToast('📧 Opening email client...');
  }
  
  async function copyToClipboard() {
    const invoiceText = getInvoiceText();
    const copyBtn = document.getElementById('copyBtn');
    const copyBtnText = document.getElementById('copyBtnText');
    
    try {
      await navigator.clipboard.writeText(invoiceText);
      
      copyBtnText.textContent = '✅ Copied!';
      showToast('✅ Invoice details copied to clipboard!');
      
      setTimeout(() => {
        copyBtnText.textContent = '📋 Copy Text';
      }, 2000);
      
    } catch (err) {
      fallbackCopyTextToClipboard(invoiceText);
    }
  }
  
  function sendInvoiceEmail() {
    const sendBtn = document.getElementById('sendEmailBtn');
    const sendText = document.getElementById('sendEmailText');
    
    sendText.textContent = 'Sending...';
    sendBtn.disabled = true;
    
    fetch('/invoices/send-email/{{ invoice.id }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        sendText.textContent = '✅ Email Sent!';
        showToast('📧 Invoice email sent successfully!');
      } else {
        sendText.textContent = '❌ Failed';
        showToast(`❌ Email failed: ${data.error}`);
      }
    })
    .catch(error => {
      sendText.textContent = '❌ Error';
      showToast('❌ Failed to send email. Please try again.');
    })
    .finally(() => {
      sendBtn.disabled = false;
      setTimeout(() => {
        sendText.textContent = '📤 Email Invoice';
      }, 3000);
    });
  }
  
  function sendPaymentReminder() {
    const reminderText = `Hi {{ invoice.client_name }},

This is a friendly reminder that invoice #{{ invoice.invoice_number }} for £{{ "%.2f"|format(invoice.total_amount) }} is due on {{ invoice.due_date }}.

{% if invoice.status == 'overdue' %}This invoice is now overdue. {% endif %}If you've already made payment, please ignore this reminder.

Thank you!
{{ current_user.username|title }}`;
    
    const encodedText = encodeURIComponent(reminderText);
    window.open(`https://wa.me/?text=${encodedText}`, '_blank');
    showToast('📱 Opening WhatsApp with payment reminder...');
  }
  
  function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'alert alert-success position-fixed animate-fade-in';
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 1050; max-width: 300px;';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 4000);
  }
  
  function fallbackCopyTextToClipboard(text) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.opacity = "0";
    
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
      const successful = document.execCommand('copy');
      if (successful) {
        showToast('✅ Invoice details copied to clipboard!');
      } else {
        showToast('❌ Failed to copy. Please try again.');
      }
    } catch (err) {
      showToast('❌ Copy not supported. Please select and copy manually.');
    }
    
    document.body.removeChild(textArea);
  }
</script>
{% endblock %}