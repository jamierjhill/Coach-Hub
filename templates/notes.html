{% extends "base.html" %}

{% block title %}üìù My Notes{% endblock %}

{% block content %}
  <div class="page-title-container">
    <h1 class="page-title">üìù My Coaching Notes</h1>
  </div>

  <div class="notes-container tennis-card">
    <!-- New note input area -->
    <div class="new-note-section mb-4">
      <h4 class="section-title mb-3">‚úèÔ∏è Create New Note</h4>
      <div class="mb-3">
        <textarea id="newNote" class="form-control" rows="3" placeholder="Write a new note..."></textarea>
      </div>
      <button id="addNoteBtn" class="btn btn-primary w-100">‚ûï Add Note</button>
    </div>

    <hr class="my-4">
    
    <!-- Saved notes section -->
    <div class="saved-notes-section">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="section-title mb-0"> Your Saved Notes</h4>
        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            Sort By
          </button>
          <ul class="dropdown-menu" aria-labelledby="sortDropdown">
            <li><a class="dropdown-item" href="#" onclick="sortNotes('newest')">Newest First</a></li>
            <li><a class="dropdown-item" href="#" onclick="sortNotes('oldest')">Oldest First</a></li>
          </ul>
        </div>
      </div>

      {% if notes and notes|length > 0 %}
        <div id="notesList" class="notes-list">
          {% for line in notes %}
            <div class="note-item">
              <div class="note-text">{{ line }}</div>
              <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteNote('{{ line }}')">üóëÔ∏è</button>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div id="notesList" class="notes-list">
          <div class="empty-notes">
            <p class="text-muted text-center">
              You don't have any notes yet.<br>
              Write your first note above.
            </p>
          </div>
        </div>
      {% endif %}
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <!-- Delete Confirmation Modal -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Confirm Deletion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          Are you sure you want to delete this note?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Variables
    let currentSort = 'newest';
    let deleteNoteContent = '';
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
    const noteInput = document.getElementById('newNote');
    const notesList = document.getElementById('notesList');
    
    // Auto-resize textarea
    noteInput.addEventListener('input', function() {
      this.style.height = 'auto';
      this.style.height = (this.scrollHeight) + 'px';
    });
  
    // Auto-save on Enter (but allow Shift+Enter for new line)
    noteInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        addNote();
      }
    });
  
    // Handle Add Note button click
    document.getElementById('addNoteBtn').addEventListener('click', function () {
      addNote();
    });
  
    // Add note function (shared between Enter and button click)
    function addNote() {
      const note = noteInput.value.trim();
      if (!note) return;
      
      // Show loading state on button
      const addBtn = document.getElementById('addNoteBtn');
      const originalText = addBtn.innerHTML;
      addBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Adding...';
      addBtn.disabled = true;
  
      fetch('/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ note })
      }).then(() => {
        // Remove empty notes placeholder if it exists
        const emptyNotes = document.querySelector('.empty-notes');
        if (emptyNotes) {
          emptyNotes.remove();
        }
        
        // Create new note item with animation
        const noteItem = document.createElement('div');
        noteItem.className = 'note-item new-note';
        noteItem.innerHTML = `
          <div class="note-text">${note}</div>
          <button class="btn btn-sm btn-outline-danger delete-btn" onclick="deleteNote('${note}')">üóëÔ∏è</button>
        `;
        
        // Apply different insertion logic based on sort order
        if (currentSort === 'newest') {
          notesList.insertBefore(noteItem, notesList.firstChild);
        } else {
          notesList.appendChild(noteItem);
        }
        
        // Clear the input
        noteInput.value = '';
        noteInput.style.height = 'auto';
        
        // Reset button state
        addBtn.innerHTML = originalText;
        addBtn.disabled = false;
      })
      .catch(error => {
        console.error('Error adding note:', error);
        addBtn.innerHTML = originalText;
        addBtn.disabled = false;
      });
    }
  
    // Ask for confirmation before deleting
    function deleteNote(note) {
      deleteNoteContent = note;
      deleteModal.show();
      
      // Set up confirmation button
      document.getElementById('confirmDelete').onclick = function() {
        performDelete(deleteNoteContent);
        deleteModal.hide();
      };
    }
    
    // Perform the actual deletion
    function performDelete(note) {
      fetch('/notes', {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ delete_note: note })
      }).then(() => {
        const items = document.querySelectorAll('.note-item');
        
        // Apply fade-out animation before removing
        items.forEach(item => {
          if (item.querySelector('.note-text')?.textContent === note) {
            item.style.transition = 'all 0.3s ease';
            item.style.opacity = '0';
            item.style.transform = 'translateX(20px)';
            
            setTimeout(() => {
              item.remove();
              
              // Show empty state if no notes left
              if (notesList.children.length === 0) {
                notesList.innerHTML = `
                  <div class="empty-notes">
                    <p class="text-muted text-center">
                      You don't have any notes yet.<br>
                      Write your first note above.
                    </p>
                  </div>
                `;
              }
            }, 300);
          }
        });
      });
    }
    
    // Sort notes function
    function sortNotes(order) {
      currentSort = order;
      const notes = Array.from(notesList.querySelectorAll('.note-item'));
      
      // Skip if there are no notes or only one note
      if (notes.length <= 1) return;
      
      // Remove all notes from DOM
      notes.forEach(note => note.remove());
      
      // Sort based on order
      if (order === 'oldest') {
        notes.reverse();
      }
      
      // Add back in sorted order
      notes.forEach(note => notesList.appendChild(note));
    }
  </script>

  <style>
    /* Additional styles specific to notes */
    .note-item {
      position: relative;
      padding: 1.25rem;
      margin-bottom: 1rem;
      background-color: #f3f6f9;
      border-left: 4px solid var(--teal);
      border-radius: 10px;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .note-item:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .note-text {
      white-space: pre-line;
      flex: 1;
    }

    .delete-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: none;
      border: none;
      color: #dc3545;
      cursor: pointer;
      padding: 0;
      font-size: 1.1rem;
      opacity: 0.5;
      transition: opacity 0.2s ease;
    }

    .delete-btn:hover {
      opacity: 1;
    }

    .new-note {
      animation: highlight 1.5s ease;
    }

    .empty-notes {
      color: #6c757d;
      padding: 2rem;
      text-align: center;
    }

    @keyframes highlight {
      from { background-color: rgba(0, 160, 126, 0.2); }
      to { background-color: #f3f6f9; }
    }
  </style>
{% endblock %}