<!-- templates/pending_confirmations.html -->
{% extends "base.html" %}

{% block title %}⏳ Pending Payment Confirmations{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">⏳ Pending Payment Confirmations</h1>
  <div class="title-nav-buttons">
    <a href="/invoices" class="btn-base btn-outline-accent">← Back to Invoices</a>
    <a href="/invoices/create" class="btn-base btn-accent">➕ New Invoice</a>
  </div>
</div>

<!-- Summary -->
<div class="summary-grid">
  <div class="summary-card" style="background: linear-gradient(135deg, var(--warning), #e67e22); color: white;">
    <div class="summary-amount">{{ pending_invoices|length }}</div>
    <div class="summary-label">Pending Confirmations</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--info), #1e88e5); color: white;">
    <div class="summary-amount">£{{ "%.0f"|format(total_pending_amount) }}</div>
    <div class="summary-label">Total Amount</div>
  </div>
  <div class="summary-card" style="background: linear-gradient(135deg, var(--danger), #c0392b); color: white;">
    <div class="summary-amount">{{ overdue_count }}</div>
    <div class="summary-label">Overdue</div>
  </div>
</div>

<!-- Instructions -->
<div class="card-border-left" style="background-color: rgba(0, 160, 126, 0.1); border-left-color: var(--teal);">
  <div class="flex align-items-center">
    <div style="font-size: 2rem; margin-right: 1rem;">💡</div>
    <div>
      <h5 class="font-medium mb-1">How Auto-Payment Works</h5>
      <p class="text-muted mb-0">
        When you email invoices to clients, they receive a special link to confirm payments themselves. 
        You'll be automatically notified when they confirm payment - no more manual tracking!
      </p>
    </div>
  </div>
</div>

<!-- Pending Invoices -->
{% if pending_invoices %}
<div class="card-base">
  <h4 class="section-title">📧 Invoices Awaiting Client Confirmation</h4>
  
  {% for invoice in pending_invoices %}
  <div class="invoice-item card-border-left hover-subtle mb-3" 
       style="border-left-color: {{ 'var(--danger)' if invoice.status == 'overdue' else 'var(--warning)' }};">
    
    <div class="flex flex-between align-items-center mb-2">
      <div class="flex-grow-1">
        <div class="flex align-items-center mb-1" style="gap: 0.5rem; flex-wrap: wrap;">
          <h6 class="font-medium mb-0">{{ invoice.client_name }}</h6>
          <span class="badge-base status-{{ 'danger' if invoice.status == 'overdue' else 'warning' }}">
            {{ invoice.status.upper() }}
          </span>
          <span class="badge-base status-info">📧 EMAILED</span>
        </div>
        
        <div class="text-sm text-muted mb-2">
          <strong>{{ invoice.invoice_number }}</strong> • {{ invoice.description }}<br>
          Due: {{ invoice.due_date }} • Email: {{ invoice.client_email }}
          {% if invoice.email_sent_date %}
          <br>📤 Sent: {{ invoice.email_sent_date }}
          {% endif %}
          {% if invoice.last_reminder_sent %}
          <br>🔔 Last reminder: {{ invoice.last_reminder_sent.split('T')[0] }}
          {% endif %}
        </div>
      </div>
      
      <div class="text-right">
        <div class="text-xl font-bold mb-2" style="color: {{ 'var(--danger)' if invoice.status == 'overdue' else 'var(--warning)' }};">
          £{{ "%.0f"|format(invoice.amount) }}
        </div>
      </div>
    </div>
    
    <div class="flex flex-wrap" style="gap: 0.5rem;">
      <button onclick="sendPaymentReminder('{{ invoice.id }}')" class="btn-base btn-info btn-sm">
        🔔 Send Reminder
      </button>
      
      <button onclick="copyPaymentLink('{{ invoice.id }}')" class="btn-base btn-outline-accent btn-sm">
        🔗 Copy Payment Link
      </button>
      
      <form action="/invoices/mark-paid/{{ invoice.id }}" method="POST" style="display: inline;">
        <button type="submit" class="btn-base btn-success btn-sm">✅ Mark Paid</button>
      </form>
      
      <a href="/invoices/view/{{ invoice.id }}" class="btn-base btn-outline-secondary btn-sm">👁️ View</a>
    </div>
    
    <!-- Hidden payment link for copying -->
    <div id="payment-link-{{ invoice.id }}" style="display: none;">{{ request.url_root }}pay/{{ invoice.id }}</div>
  </div>
  {% endfor %}
</div>

{% else %}
<!-- Empty State -->
<div class="card-base">
  <div class="empty-state">
    <div class="empty-icon">⏳</div>
    <h4>No Pending Confirmations</h4>
    <p class="text-muted mb-4">
      Great! You don't have any invoices waiting for client payment confirmation.
    </p>
    
    <div class="flex flex-column" style="gap: 1rem; align-items: center;">
      <p class="text-sm text-muted text-center mb-3">
        💡 To use auto-payment confirmation:<br>
        1. Create invoices with client email addresses<br>
        2. Email the invoices to clients<br>
        3. Clients click the payment link to confirm<br>
        4. You get notified automatically!
      </p>
      
      <a href="/invoices/create" class="btn-base btn-accent">Create New Invoice</a>
    </div>
  </div>
</div>
{% endif %}

<!-- Payment Statistics -->
{% if pending_invoices %}
<div class="card-base">
  <h4 class="section-title">📊 Payment Confirmation Stats</h4>
  
  <div class="row g-3">
    <div class="col-md-3 col-6">
      <div class="text-center">
        <div class="h4 mb-1" style="color: var(--info);">{{ pending_invoices|length }}</div>
        <div class="text-muted small">Awaiting Confirmation</div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="text-center">
        <div class="h4 mb-1" style="color: var(--warning);">
          {{ pending_invoices|selectattr("reminder_count")|list|length }}
        </div>
        <div class="text-muted small">Reminders Sent</div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="text-center">
        <div class="h4 mb-1" style="color: var(--danger);">{{ overdue_count }}</div>
        <div class="text-muted small">Overdue</div>
      </div>
    </div>
    <div class="col-md-3 col-6">
      <div class="text-center">
        <div class="h4 mb-1" style="color: var(--teal);">
          £{{ "%.0f"|format(total_pending_amount / pending_invoices|length if pending_invoices|length > 0 else 0) }}
        </div>
        <div class="text-muted small">Avg Amount</div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  function sendPaymentReminder(invoiceId) {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '⏳ Sending...';
    button.disabled = true;
    
    fetch(`/invoices/send-payment-reminder/${invoiceId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        button.innerHTML = '✅ Sent!';
        showToast('🔔 Payment reminder sent successfully!', 'success');
        
        // Update the UI to show reminder was sent
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        }, 2000);
      } else {
        button.innerHTML = '❌ Failed';
        showToast(`❌ ${data.error}`, 'danger');
        
        setTimeout(() => {
          button.innerHTML = originalText;
          button.disabled = false;
        }, 2000);
      }
    })
    .catch(error => {
      button.innerHTML = '❌ Error';
      showToast('❌ Failed to send reminder', 'danger');
      
      setTimeout(() => {
        button.innerHTML = originalText;
        button.disabled = false;
      }, 2000);
    });
  }
  
  function copyPaymentLink(invoiceId) {
    const linkElement = document.getElementById(`payment-link-${invoiceId}`);
    const paymentLink = linkElement.textContent;
    
    if (navigator.clipboard) {
      navigator.clipboard.writeText(paymentLink).then(() => {
        showToast('🔗 Payment link copied to clipboard!', 'success');
      });
    } else {
      // Fallback for older browsers
      const textArea = document.createElement('textarea');
      textArea.value = paymentLink;
      document.body.appendChild(textArea);
      textArea.select();
      document.execCommand('copy');
      document.body.removeChild(textArea);
      showToast('🔗 Payment link copied!', 'success');
    }
  }
  
  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
    toast.style.cssText = `
      background: ${type === 'success' ? 'var(--success)' : type === 'danger' ? 'var(--danger)' : 'var(--info)'};
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 8px;
      z-index: 1050;
      font-size: 0.875rem;
      max-width: 90%;
      text-align: center;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      animation: slideDown 0.3s ease;
    `;
    
    toast.textContent = message;
    document.body.appendChild(toast);
    
    setTimeout(() => {
      toast.style.animation = 'slideUp 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }
</script>

<style>
@keyframes slideDown {
  from { transform: translate(-50%, -100%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

@keyframes slideUp {
  from { transform: translate(-50%, 0); opacity: 1; }
  to { transform: translate(-50%, -100%); opacity: 0; }
}
</style>
{% endblock %}