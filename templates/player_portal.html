{% extends "base.html" %}

{% block title %}ðŸŽ¾ Player Portal{% endblock %}

{% block extra_css %}
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
<style>
  /* Player Portal specific styles */
  .bulletin-message {
    margin-bottom: 15px;
    padding: 15px;
    border-radius: 10px;
    background-color: var(--light);
    border-left: 4px solid var(--teal);
  }
  
  .bulletin-content {
    margin-bottom: 5px;
    white-space: pre-line;
  }
  
  .bulletin-timestamp {
    font-size: var(--font-xxs);
    color: var(--text-secondary);
  }
  

  
  .tennis-tip {
    background-color: rgba(0, 160, 126, 0.1);
    border-radius: 10px;
    padding: 12px;
    margin-top: 15px;
    display: flex;
    align-items: flex-start;
  }
  
  .tip-icon {
    margin-right: 10px;
    font-size: 1.2rem;
  }
  


  
  .upcoming-event-item {
    padding: 12px;
    margin-bottom: 10px;
    border-radius: 8px;
    background-color: var(--light);
    border-left: 3px solid var(--teal);
  }
  
  
  @keyframes typing {
    0%, 100% { opacity: 0.3; transform: translateY(0); }
    50% { opacity: 1; transform: translateY(-5px); }
  }
</style>
{% endblock %}

{% block content %}
<div class="page-title-container">
  <h1 class="page-title">ðŸŽ¾ {{ title }}</h1>
  <p class="page-subtitle">Player Portal</p>
  <div class="title-nav-buttons">
    <a href="/logout" class="btn-base btn-outline-accent">ðŸšª Logout</a>
  </div>
</div>

<div class="row g-4">
  <!-- ðŸ“¢ Bulletin Section -->
  <div class="col-lg-7">
    <div class="card-base">
      <h3 class="section-title">ðŸ“¢ Bulletin Board</h3>
      {% if bulletin_messages %}
        <div class="bulletin-messages">
          {% for msg in bulletin_messages|reverse %}
            <div class="bulletin-message">
              <div class="bulletin-content">{{ msg.text }}</div>
              <div class="bulletin-timestamp">{{ msg.timestamp }}</div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <div class="empty-state">
          <div class="empty-icon">ðŸ“Œ</div>
          <p>No bulletins posted yet.</p>
        </div>
      {% endif %}
    </div>
    
  
        

        

  <div class="col-lg-5">
    <!-- ðŸ“§ Notification Signup -->
    <div class="card-base">
      <h3 class="section-title">ðŸ“§ Get Updates</h3>
      <p class="text-sm mb-3">Subscribe to receive email updates from your coach.</p>
      
      <div class="card-border-left">
        <div class="nav nav-tabs mb-3" id="subscription-tabs" role="tablist">
          <button class="nav-link active" id="subscribe-tab" data-bs-toggle="tab" data-bs-target="#subscribe-panel" type="button" role="tab" aria-selected="true">Subscribe</button>
          <button class="nav-link" id="unsubscribe-tab" data-bs-toggle="tab" data-bs-target="#unsubscribe-panel" type="button" role="tab" aria-selected="false">Unsubscribe</button>
        </div>
        
        <div class="tab-content">
          <div class="tab-pane fade show active" id="subscribe-panel" role="tabpanel">
            <form method="POST" action="/subscribe-email">
              <div class="input-group mb-2">
                <input type="email" name="email" class="input-base" placeholder="Enter your email" required>
                <button type="submit" class="btn-base btn-accent">Subscribe</button>
              </div>
              <div class="form-text text-xxs">You'll receive notifications about new bulletins and events.</div>
            </form>
          </div>
          
          <div class="tab-pane fade" id="unsubscribe-panel" role="tabpanel">
            <form method="POST" action="/unsubscribe-email">
              <div class="input-group mb-2">
                <input type="email" name="email" class="input-base" placeholder="Enter your email" required>
                <button type="submit" class="btn-base btn-outline-danger">Unsubscribe</button>
              </div>
              <div class="form-text text-xxs">You'll no longer receive email notifications.</div>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- ðŸ“… Calendar Section -->
    <div class="card-base">
      <h3 class="section-title">ðŸ“… Coaching Calendar</h3>
      <div id="calendar" class="mb-3"></div>
      <div class="mt-3">
        <h5 class="font-medium mb-3">Upcoming Events</h5>
        <div id="upcoming-events-list">
          <div class="text-center text-muted">Loading events...</div>
        </div>
      </div>
    </div>


  </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Initialize Calendar
    initializeCalendar();
    
    // Initialize Chat with welcome message
    initializeChat();
    
    // Handle Enter key press for chat
    document.getElementById('chatInput').addEventListener('keydown', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        sendChat();
      }
    });
  });
  
  // Calendar Initialization
  function initializeCalendar() {
    const calendarEl = document.getElementById('calendar');
    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'dayGridMonth',
      headerToolbar: {
        left: 'prev,next',
        center: 'title',
        right: 'today'
      },
      height: 450,
      events: "/api/events",
      eventDidMount: function(info) {
        // Add hover effect
        info.el.style.transition = 'transform 0.2s ease, box-shadow 0.2s ease';
        info.el.addEventListener('mouseover', function() {
          this.style.transform = 'translateY(-2px)';
          this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.1)';
        });
        info.el.addEventListener('mouseout', function() {
          this.style.transform = 'translateY(0)';
          this.style.boxShadow = 'none';
        });
      },
      eventClick: function(info) {
        // Show event details
        const event = info.event;
        const start = event.start ? formatDateTime(event.start) : 'All day';
        const end = event.end ? formatDateTime(event.end) : '';
        
        alert(`${event.title}\n${start}${end ? ' - ' + end : ''}`);
      },
      datesSet: function(dateInfo) {
        // Update upcoming events list when calendar view changes
        updateUpcomingEvents(calendar);
      }
    });
    
    calendar.render();
    updateUpcomingEvents(calendar);
  }
  
  // Format date and time for event display
  function formatDateTime(date) {
    return date.toLocaleString('en-GB', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
  // Update the upcoming events list
  function updateUpcomingEvents(calendar) {
    const now = new Date();
    const futureEvents = calendar.getEvents()
      .filter(e => new Date(e.start) >= now)
      .sort((a, b) => new Date(a.start) - new Date(b.start))
      .slice(0, 3);
      
    const listEl = document.getElementById('upcoming-events-list');
    
    if (futureEvents.length === 0) {
      listEl.innerHTML = `
        <div class="empty-state">
          <p>No upcoming events scheduled</p>
        </div>
      `;
      return;
    }
    
    listEl.innerHTML = '';
    futureEvents.forEach(event => {
      const eventDate = new Date(event.start);
      const timeString = event.allDay ? 'All day' : formatTime(eventDate);
      const dateString = formatDate(eventDate);
      
      const li = document.createElement('div');
      li.className = 'upcoming-event-item';
      li.innerHTML = `
        <div class="event-date font-medium">${dateString}</div>
        <div class="event-details">
          <div class="event-title font-medium">${event.title}</div>
          <div class="event-time text-xs text-muted">${timeString}</div>
        </div>
      `;
      listEl.appendChild(li);
    });
  }
  
  function formatDate(date) {
    return date.toLocaleDateString('en-GB', {
      weekday: 'short',
      month: 'short',
      day: 'numeric'
    });
  }
  
  function formatTime(date) {
    return date.toLocaleTimeString('en-GB', {
      hour: '2-digit',
      minute: '2-digit'
    });
  }
  
 
</script>
{% endblock %}