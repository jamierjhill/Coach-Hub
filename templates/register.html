{% extends "base.html" %}

{% block title %}🎾 Coach Registration{% endblock %}

{% block body_class %}register-page{% endblock %}

{% block container_class %}container min-vh-100 d-flex align-items-center justify-content-center py-5{% endblock %}

{% block content %}
  <div class="w-100" style="max-width: 450px;">
    
    <!-- PWA Install Banner -->
    <div class="card-border" id="installBanner" style="display: none; margin-bottom: 1.5rem;">
      <div class="flex items-center gap-4">
        <div style="width: 48px; height: 48px; background: linear-gradient(145deg, var(--primary), var(--primary-dark)); border-radius: var(--radius-lg); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; flex-shrink: 0;">
          🎾
        </div>
        <div class="flex-grow-1">
          <h5 class="mb-1 font-semibold">Install Coaches Hub</h5>
          <p class="text-sm text-secondary mb-2">Add to your home screen for faster access and offline support!</p>
          <div class="flex gap-2">
            <button id="installButton" class="btn btn-primary btn-sm">
              📱 Install Now
            </button>
            <button id="dismissButton" class="btn btn-secondary btn-sm">
              Maybe Later
            </button>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Main Registration Card -->
    <div class="card">
      <div class="text-center mb-6">
        <h1 class="text-2xl font-bold text-primary mb-2">🎾 Join Coaches Hub</h1>
        <p class="text-secondary">Create your coaching account</p>
      </div>
      
      <!-- Registration Form -->
      <form method="POST" action="/register" id="registrationForm">
        
        <div class="form-group">
          <label class="form-label">Username *</label>
          <input type="text" name="username" class="form-input" required 
                 placeholder="e.g. coachjamie" autocomplete="username">
          <div class="form-error" id="username-error" style="display: none;"></div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Email Address *</label>
          <input type="email" name="email" class="form-input" required 
                 placeholder="e.g. jamie@email.com" autocomplete="email">
          <div class="form-error" id="email-error" style="display: none;"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Password *</label>
          <input type="password" name="password" class="form-input" required 
                 placeholder="Choose a strong password" autocomplete="new-password">
          <div class="text-xs text-secondary mt-1">
            💡 Use at least 8 characters with letters and numbers
          </div>
          <div class="form-error" id="password-error" style="display: none;"></div>
        </div>

        <div class="form-group">
          <label class="form-label">Coaching Location (Optional)</label>
          <input type="text" name="postcode" class="form-input" 
                 placeholder="e.g. SW19 5AE" autocomplete="postal-code">
          <div class="text-xs text-secondary mt-1">
            📍 Help us personalize your experience
          </div>
        </div>

        <!-- Security Verification -->
        <div class="form-group">
          <div class="card-border" style="background-color: rgba(0, 160, 126, 0.05);">
            <label class="form-label font-medium">🔐 Security Verification</label>
            <div class="flex items-center gap-2 mb-2">
              <span class="badge-primary" style="font-size: 1rem; padding: 0.5rem 1rem;">
                {{ captcha_question if captcha_question else "5 + 3" }}
              </span>
              <span class="font-bold text-lg">=</span>
              <input type="number" name="captcha_answer" class="form-input" 
                     style="width: 80px;" placeholder="?" required autocomplete="off">
              <button type="button" class="btn btn-secondary btn-sm" onclick="refreshCaptcha()">
                🔄 New
              </button>
            </div>
            <div class="text-xs text-secondary">
              💡 Solve the math problem to verify you're human
            </div>
          </div>
        </div>

        <!-- GDPR Consent -->
        <div class="form-group">
          <div class="card-border" style="background-color: rgba(52, 152, 219, 0.05);">
            <div class="form-check d-flex align-items-start gap-3">
              <input type="checkbox" class="form-check-input mt-1" id="gdprConsent" 
                     name="gdpr_consent" required style="flex-shrink: 0;">
              <label class="form-check-label text-sm" for="gdprConsent">
                I agree to the <a href="/privacy-policy" target="_blank" class="text-primary">Privacy Policy</a> 
                and consent to data processing as described. I understand I can withdraw consent at any time.
              </label>
            </div>
          </div>
        </div>
        
        <!-- Submit Button -->
        <button type="submit" class="btn btn-primary btn-lg w-100 mb-4" id="submitBtn">
          <span id="submitText">✨ Create My Account</span>
          <span id="submitSpinner" class="spinner-border spinner-border-sm ms-2" 
                style="display: none;" role="status" aria-hidden="true"></span>
        </button>
        
        <!-- Login Link -->
        <div class="text-center">
          <p class="text-secondary">
            Already have an account? 
            <a href="/login" class="text-primary font-medium">Sign in here</a>
          </p>
        </div>
        
      </form>
    </div>
    
    <!-- Learn More Link -->
    <div class="text-center mt-4">
      <a href="/learn-more" class="btn btn-secondary btn-sm">
        📣 Learn More About Coaches Hub
      </a>
    </div>
    
  </div>
{% endblock %}

{% block footer %}
  <footer class="text-center text-secondary py-4">
    <p class="text-sm">
      Built by Jamie • v2.2 • 
      <a href="/contact" class="text-primary">Contact Us</a> • 
      <a href="/privacy-policy" class="text-primary">Privacy</a>
    </p>
  </footer>
{% endblock %}

{% block extra_js %}
<script>
// Form validation and enhancement
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('registrationForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const submitSpinner = document.getElementById('submitSpinner');
  
  // Enhanced form validation
  const inputs = form.querySelectorAll('input[required]');
  
  inputs.forEach(input => {
    // Real-time validation feedback
    input.addEventListener('blur', validateField);
    input.addEventListener('input', clearError);
  });
  
  function validateField(e) {
    const field = e.target;
    const value = field.value.trim();
    const fieldName = field.name;
    const errorElement = document.getElementById(`${fieldName}-error`);
    
    let isValid = true;
    let errorMessage = '';
    
    // Required field check
    if (!value) {
      isValid = false;
      errorMessage = `${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} is required`;
    }
    
    // Specific validation rules
    switch (fieldName) {
      case 'email':
        if (value && !value.includes('@')) {
          isValid = false;
          errorMessage = 'Please enter a valid email address';
        }
        break;
        
      case 'password':
        if (value && value.length < 6) {
          isValid = false;
          errorMessage = 'Password must be at least 6 characters long';
        }
        break;
        
      case 'username':
        if (value && (value.length < 3 || !/^[a-zA-Z0-9_-]+$/.test(value))) {
          isValid = false;
          errorMessage = 'Username must be 3+ characters, letters, numbers, - and _ only';
        }
        break;
    }
    
    // Update field appearance
    if (isValid) {
      field.style.borderColor = 'var(--success)';
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    } else {
      field.style.borderColor = 'var(--danger)';
      if (errorElement) {
        errorElement.textContent = errorMessage;
        errorElement.style.display = 'block';
      }
    }
    
    return isValid;
  }
  
  function clearError(e) {
    const field = e.target;
    const errorElement = document.getElementById(`${field.name}-error`);
    
    if (field.style.borderColor === 'rgb(231, 76, 60)') {
      field.style.borderColor = '';
      if (errorElement) {
        errorElement.style.display = 'none';
      }
    }
  }
  
  // Form submission handling
  form.addEventListener('submit', function(e) {
    // Validate all required fields
    let allValid = true;
    inputs.forEach(input => {
      if (!validateField({ target: input })) {
        allValid = false;
      }
    });
    
    // Check GDPR consent
    const gdprConsent = document.getElementById('gdprConsent');
    if (!gdprConsent.checked) {
      allValid = false;
      alert('Please accept the privacy policy to continue.');
      gdprConsent.focus();
    }
    
    if (!allValid) {
      e.preventDefault();
      return false;
    }
    
    // Show loading state
    submitText.textContent = 'Creating Account...';
    submitSpinner.style.display = 'inline-block';
    submitBtn.disabled = true;
  });
});

// CAPTCHA refresh functionality
function refreshCaptcha() {
  const refreshBtn = event.target;
  const originalText = refreshBtn.innerHTML;
  
  refreshBtn.innerHTML = '⏳';
  refreshBtn.disabled = true;
  
  fetch('/refresh-captcha', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      document.querySelector('.badge-primary').textContent = data.question;
      document.querySelector('input[name="captcha_answer"]').value = '';
      document.querySelector('input[name="captcha_answer"]').focus();
      showToast('🔄 New security question generated');
    } else {
      showToast('❌ Could not refresh question', 'error');
    }
  })
  .catch(error => {
    console.error('Error refreshing captcha:', error);
    showToast('❌ Network error', 'error');
  })
  .finally(() => {
    refreshBtn.innerHTML = originalText;
    refreshBtn.disabled = false;
  });
}

// PWA Installation
document.addEventListener('DOMContentLoaded', function() {
  let deferredPrompt;
  const installButton = document.getElementById('installButton');
  const dismissButton = document.getElementById('dismissButton');
  const installBanner = document.getElementById('installBanner');
  
  // Listen for install prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Don't show if already installed or dismissed recently
    if (localStorage.getItem('appInstalled') === 'true') return;
    
    const lastDismissed = parseInt(localStorage.getItem('installLaterClicked') || 0);
    if (lastDismissed && (Date.now() - lastDismissed < 2 * 24 * 60 * 60 * 1000)) return;
    
    // Show banner after delay
    setTimeout(() => {
      installBanner.style.display = 'block';
      installBanner.classList.add('fade-in');
    }, 2000);
  });
  
  // Handle install
  installButton?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    deferredPrompt.prompt();
    const { outcome } = await deferredPrompt.userChoice;
    
    deferredPrompt = null;
    installBanner.style.display = 'none';
    
    if (outcome === 'accepted') {
      localStorage.setItem('appInstalled', 'true');
      showToast('🎾 App installed successfully!');
    }
  });
  
  // Handle dismiss
  dismissButton?.addEventListener('click', () => {
    installBanner.style.display = 'none';
    localStorage.setItem('installLaterClicked', Date.now());
    showToast('💭 You can install later from your browser menu');
  });
  
  // Hide if already installed
  window.addEventListener('appinstalled', () => {
    installBanner.style.display = 'none';
    localStorage.setItem('appInstalled', 'true');
  });
});

// Toast notification helper
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.className = 'position-fixed top-0 start-50 translate-middle-x mt-3';
  toast.style.cssText = `
    background: ${type === 'error' ? 'var(--danger)' : 'var(--primary)'};
    color: white;
    padding: 0.75rem 1rem;
    border-radius: var(--radius);
    z-index: 1050;
    font-size: 0.875rem;
    box-shadow: var(--shadow-lg);
    animation: slideDown 0.3s ease;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideUp 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// Auto-dismiss alerts
setTimeout(() => {
  document.querySelectorAll('.alert').forEach(alert => {
    if (alert.classList.contains('show')) {
      alert.classList.remove('show');
      alert.classList.add('fade');
      setTimeout(() => alert.remove(), 500);
    }
  });
}, 5000);
</script>

<style>
/* Custom animations for this page */
@keyframes slideDown {
  from { transform: translate(-50%, -100%); opacity: 0; }
  to { transform: translate(-50%, 0); opacity: 1; }
}

@keyframes slideUp {
  from { transform: translate(-50%, 0); opacity: 1; }
  to { transform: translate(-50%, -100%); opacity: 0; }
}

/* Badge primary style */
.badge-primary {
  background: linear-gradient(145deg, var(--primary), var(--primary-dark));
  color: white;
  border-radius: var(--radius);
  font-weight: 600;
}

/* Mobile optimizations */
@media (max-width: 767px) {
  .container {
    padding: var(--space-4);
  }
  
  .card {
    padding: var(--space-4);
  }
  
  .page-title {
    font-size: var(--text-xl);
  }
  
  .flex {
    flex-wrap: wrap;
  }
  
  .gap-2 {
    gap: var(--space-2);
  }
  
  /* Stack captcha elements on mobile */
  .flex.items-center.gap-2 {
    flex-direction: column;
    align-items: stretch;
    gap: var(--space-3);
  }
  
  .flex.items-center.gap-2 input[name="captcha_answer"] {
    width: 100%;
  }
}

/* Focus states for accessibility */
.form-input:focus,
.form-check-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: 0 0 0 3px rgba(0, 160, 126, 0.1);
}

/* Loading button state */
.btn:disabled {
  opacity: 0.7;
  cursor: not-allowed;
}
</style>
{% endblock %}