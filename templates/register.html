{% extends "base.html" %}

{% block title %}üéæ Join Coaches Hub{% endblock %}

{% block body_class %}register-page{% endblock %}

{% block container_class %}container min-vh-100 d-flex align-items-center justify-content-center py-4{% endblock %}

{% block extra_css %}
<style>
  /* Registration page specific styles using existing system */
  .register-container {
    width: 100%;
    max-width: 480px;
    margin: 0 auto;
  }
  
  .register-card {
    background: var(--white);
    border-radius: var(--card-radius);
    box-shadow: var(--card-shadow);
    padding: var(--space-xl);
    margin-bottom: var(--space-lg);
    position: relative;
    overflow: hidden;
  }
  
  .register-card::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 4px;
    background: linear-gradient(90deg, var(--teal), var(--navy));
  }
  
  .register-header {
    text-align: center;
    margin-bottom: var(--space-xl);
  }
  
  .register-logo {
    width: 64px;
    height: 64px;
    background: linear-gradient(135deg, var(--teal), var(--teal-dark));
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 2rem;
    margin: 0 auto var(--space-md);
    box-shadow: 0 4px 12px rgba(0, 160, 126, 0.3);
  }
  
  .register-title {
    font-size: 1.75rem;
    font-weight: 700;
    color: var(--navy);
    margin-bottom: var(--space-sm);
  }
  
  .register-subtitle {
    color: var(--text-secondary);
    font-size: 1rem;
    margin-bottom: 0;
  }
  
  /* Enhanced form styling */
  .form-group {
    margin-bottom: var(--space-lg);
    position: relative;
  }
  
  .form-group.required .form-label::after {
    content: ' *';
    color: var(--danger);
    font-weight: 600;
  }
  
  .input-wrapper {
    position: relative;
  }
  
  .input-icon {
    position: absolute;
    left: 1rem;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.1rem;
    color: var(--text-secondary);
    z-index: 2;
  }
  
  .input-base.with-icon {
    padding-left: 3rem;
  }
  
  .input-base {
    transition: all var(--transition-speed) ease;
    border-width: 2px;
  }
  
  .input-base:focus {
    border-color: var(--teal);
    box-shadow: 0 0 0 3px rgba(0, 160, 126, 0.1);
    transform: translateY(-1px);
  }
  
  .input-base.valid {
    border-color: var(--success);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%2300a07e'%3e%3cpath d='M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z'/%3e%3c/svg%3e");
    background-position: right 1rem center;
    background-repeat: no-repeat;
    background-size: 1rem;
    padding-right: 3rem;
  }
  
  .input-base.error {
    border-color: var(--danger);
    background-color: rgba(231, 76, 60, 0.02);
    animation: shake 0.3s ease-in-out;
  }
  
  /* Error feedback */
  .form-error {
    color: var(--danger);
    font-size: 0.875rem;
    margin-top: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  
  .form-error::before {
    content: '‚ö†Ô∏è';
    font-size: 1rem;
  }
  
  /* Success feedback */
  .form-success {
    color: var(--success);
    font-size: 0.875rem;
    margin-top: var(--space-sm);
    display: flex;
    align-items: center;
    gap: var(--space-sm);
  }
  
  .form-success::before {
    content: '‚úÖ';
    font-size: 1rem;
  }
  
  /* Enhanced CAPTCHA styling */
  .captcha-section {
    background: linear-gradient(135deg, rgba(0, 160, 126, 0.05), rgba(0, 34, 62, 0.05));
    border: 2px solid rgba(0, 160, 126, 0.1);
    border-radius: var(--card-radius);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
    position: relative;
  }
  
  .captcha-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
  }
  
  .captcha-icon {
    width: 32px;
    height: 32px;
    background: var(--navy);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
  }
  
  .captcha-title {
    font-weight: 600;
    color: var(--navy);
    margin: 0;
  }
  
  .captcha-layout {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
    flex-wrap: wrap;
    justify-content: center;
  }
  
  .captcha-question {
    background: linear-gradient(135deg, var(--navy), var(--navy-light));
    color: white;
    font-size: 1.1rem;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 25px;
    border: none;
    min-width: 120px;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0, 34, 62, 0.2);
    letter-spacing: 0.5px;
  }
  
  .captcha-equals {
    font-size: 1.5rem;
    font-weight: 700;
    color: var(--navy);
  }
  
  .captcha-input {
    width: 80px;
    text-align: center;
    font-size: 1.2rem;
    font-weight: 600;
    padding: 0.75rem;
    border: 2px solid var(--teal);
    border-radius: var(--input-radius);
    background: var(--white);
  }
  
  .captcha-refresh {
    background: var(--light);
    border: 1px solid var(--light-border);
    color: var(--text-secondary);
    padding: 0.75rem 1rem;
    border-radius: var(--btn-radius);
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    font-size: 0.875rem;
    font-weight: 500;
  }
  
  .captcha-refresh:hover {
    background: var(--white);
    border-color: var(--teal);
    color: var(--teal);
    transform: translateY(-1px);
  }
  
  .captcha-help {
    font-size: 0.875rem;
    color: var(--text-secondary);
    text-align: center;
    margin: 0;
  }
  
  /* Enhanced GDPR section */
  .gdpr-section {
    background: rgba(52, 152, 219, 0.05);
    border: 2px solid rgba(52, 152, 219, 0.1);
    border-radius: var(--card-radius);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
  }
  
  .gdpr-checkbox {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
  }
  
  .form-check-input {
    width: 1.25rem;
    height: 1.25rem;
    margin-top: 0.125rem;
    flex-shrink: 0;
    border: 2px solid var(--light-border);
    border-radius: 4px;
  }
  
  .form-check-input:checked {
    background-color: var(--teal);
    border-color: var(--teal);
  }
  
  .gdpr-text {
    font-size: 0.9rem;
    line-height: 1.5;
    color: var(--text-primary);
  }
  
  .gdpr-text a {
    color: var(--teal);
    text-decoration: none;
    font-weight: 500;
  }
  
  .gdpr-text a:hover {
    text-decoration: underline;
  }
  
  /* Submit button enhancement */
  .submit-button {
    background: linear-gradient(135deg, var(--teal), var(--teal-dark));
    color: white;
    border: none;
    padding: 1rem 2rem;
    border-radius: var(--btn-radius);
    font-size: 1rem;
    font-weight: 600;
    width: 100%;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
    position: relative;
    overflow: hidden;
    min-height: 56px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-sm);
  }
  
  .submit-button::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s ease;
  }
  
  .submit-button:hover::before {
    left: 100%;
  }
  
  .submit-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0, 160, 126, 0.3);
  }
  
  .submit-button:disabled {
    opacity: 0.7;
    cursor: not-allowed;
    transform: none;
  }
  
  .submit-button:disabled:hover {
    transform: none;
    box-shadow: none;
  }
  
  /* Loading spinner */
  .spinner {
    width: 1.2rem;
    height: 1.2rem;
    border: 2px solid rgba(255,255,255,0.3);
    border-top: 2px solid white;
    border-radius: 50%;
    animation: spin 1s linear infinite;
  }
  
  /* PWA install banner */
  .install-banner {
    background: linear-gradient(135deg, var(--navy), var(--navy-light));
    color: white;
    border-radius: var(--card-radius);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
    display: none;
  }
  
  .install-content {
    display: flex;
    align-items: center;
    gap: var(--space-md);
  }
  
  .install-icon {
    width: 48px;
    height: 48px;
    background: rgba(255,255,255,0.1);
    border-radius: var(--btn-radius);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.5rem;
    flex-shrink: 0;
  }
  
  .install-text h5 {
    margin: 0 0 var(--space-sm) 0;
    font-weight: 600;
  }
  
  .install-text p {
    margin: 0 0 var(--space-md) 0;
    font-size: 0.9rem;
    opacity: 0.9;
  }
  
  .install-actions {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
  }
  
  .install-btn {
    background: white;
    color: var(--navy);
    border: none;
    padding: 0.5rem 1rem;
    border-radius: var(--btn-radius);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-speed) ease;
  }
  
  .install-btn.secondary {
    background: rgba(255,255,255,0.1);
    color: white;
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  /* Mobile responsive improvements */
  @media (max-width: 768px) {
    .register-container {
      padding: var(--space-md);
    }
    
    .register-card {
      padding: var(--space-lg);
    }
    
    .register-title {
      font-size: 1.5rem;
    }
    
    .captcha-layout {
      flex-direction: column;
      gap: var(--space-md);
      align-items: stretch;
    }
    
    .captcha-question {
      width: 100%;
      max-width: 250px;
      margin: 0 auto;
    }
    
    .captcha-input {
      width: 100px;
      margin: 0 auto;
    }
    
    .captcha-refresh {
      width: 100%;
      max-width: 200px;
      margin: 0 auto;
    }
    
    .install-content {
      flex-direction: column;
      text-align: center;
    }
    
    .install-actions {
      justify-content: center;
      width: 100%;
    }
    
    .install-btn {
      flex: 1;
      min-width: 120px;
    }
  }
  
  /* Animations */
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-5px); }
    75% { transform: translateX(5px); }
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .fade-in {
    animation: fadeIn 0.5s ease;
  }
  
  /* Password strength indicator */
  .password-strength {
    margin-top: var(--space-sm);
    padding: var(--space-sm);
    border-radius: var(--btn-radius);
    background: var(--light);
    display: none;
  }
  
  .password-strength.show {
    display: block;
  }
  
  .strength-indicator {
    height: 4px;
    background: var(--light-border);
    border-radius: 2px;
    margin-bottom: var(--space-sm);
    overflow: hidden;
  }
  
  .strength-fill {
    height: 100%;
    transition: all var(--transition-speed) ease;
    border-radius: 2px;
  }
  
  .strength-fill.weak {
    width: 33%;
    background: var(--danger);
  }
  
  .strength-fill.medium {
    width: 66%;
    background: var(--warning);
  }
  
  .strength-fill.strong {
    width: 100%;
    background: var(--success);
  }
  
  .strength-text {
    font-size: 0.8rem;
    color: var(--text-secondary);
  }
  
  /* High contrast mode support */
  @media (prefers-contrast: high) {
    .register-card {
      border: 2px solid var(--text-primary);
    }
    
    .captcha-section,
    .gdpr-section {
      border-width: 3px;
    }
    
    .input-base {
      border-width: 2px;
    }
  }
  
  /* Reduced motion */
  @media (prefers-reduced-motion: reduce) {
    .input-base,
    .submit-button,
    .captcha-refresh {
      transition: none;
    }
    
    .input-base.error {
      animation: none;
    }
    
    .spinner {
      animation: none;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="register-container">
  
  <!-- PWA Install Banner -->
  <div class="install-banner" id="installBanner">
    <div class="install-content">
      <div class="install-icon">üéæ</div>
      <div class="install-text">
        <h5>Install Coaches Hub</h5>
        <p>Add to your home screen for faster access and offline support!</p>
        <div class="install-actions">
          <button id="installButton" class="install-btn">üì± Install Now</button>
          <button id="dismissButton" class="install-btn secondary">Maybe Later</button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Main Registration Card -->
  <div class="register-card fade-in">
    <div class="register-header">
      <div class="register-logo">üéæ</div>
      <h1 class="register-title">Join Coaches Hub</h1>
      <p class="register-subtitle">Create your coaching account and start organizing better sessions</p>
    </div>
    
    <!-- Registration Form -->
    <form method="POST" action="/register" id="registrationForm" novalidate>
      
      <!-- Username Field -->
      <div class="form-group required">
        <label class="form-label">Username</label>
        <div class="input-wrapper">
          <div class="input-icon">üë§</div>
          <input type="text" name="username" id="username" class="input-base with-icon" 
                 placeholder="e.g. coachjamie" autocomplete="username" required
                 pattern="^[a-zA-Z0-9_-]{3,20}$">
        </div>
        <div class="form-error" id="username-error" style="display: none;"></div>
        <div class="form-success" id="username-success" style="display: none;"></div>
      </div>
      
      <!-- Email Field -->
      <div class="form-group required">
        <label class="form-label">Email Address</label>
        <div class="input-wrapper">
          <div class="input-icon">üìß</div>
          <input type="email" name="email" id="email" class="input-base with-icon" 
                 placeholder="e.g. jamie@email.com" autocomplete="email" required>
        </div>
        <div class="form-error" id="email-error" style="display: none;"></div>
        <div class="form-success" id="email-success" style="display: none;"></div>
      </div>
      
      <!-- Password Field -->
      <div class="form-group required">
        <label class="form-label">Password</label>
        <div class="input-wrapper">
          <div class="input-icon">üîí</div>
          <input type="password" name="password" id="password" class="input-base with-icon" 
                 placeholder="Choose a strong password" autocomplete="new-password" required
                 minlength="8">
        </div>
        <div class="password-strength" id="passwordStrength">
          <div class="strength-indicator">
            <div class="strength-fill" id="strengthFill"></div>
          </div>
          <div class="strength-text" id="strengthText">Password strength: Weak</div>
        </div>
        <div class="form-error" id="password-error" style="display: none;"></div>
        <div class="form-success" id="password-success" style="display: none;"></div>
      </div>
      
      <!-- Location Field -->
      <div class="form-group">
        <label class="form-label">Coaching Location <span style="color: var(--text-secondary); font-weight: normal;">(Optional)</span></label>
        <div class="input-wrapper">
          <div class="input-icon">üìç</div>
          <input type="text" name="postcode" id="postcode" class="input-base with-icon" 
                 placeholder="e.g. SW19 5AE" autocomplete="postal-code">
        </div>
        <div class="form-text">Help us personalize your experience</div>
      </div>
      
      <!-- Security Verification (CAPTCHA) -->
      <div class="captcha-section">
        <div class="captcha-header">
          <div class="captcha-icon">üîê</div>
          <h4 class="captcha-title">Security Verification</h4>
        </div>
        <div class="captcha-layout">
          <div class="captcha-question">{{ captcha_question if captcha_question else "5 + 3" }}</div>
          <div class="captcha-equals">=</div>
          <input type="number" name="captcha_answer" id="captcha_answer" class="captcha-input" 
                 placeholder="?" required autocomplete="off" min="0" max="9999">
          <button type="button" class="captcha-refresh" onclick="refreshCaptcha()">
            üîÑ New Question
          </button>
        </div>
        <p class="captcha-help">üí° Solve the math problem to verify you're human</p>
      </div>
      
      <!-- GDPR Consent -->
      <div class="gdpr-section">
        <div class="gdpr-checkbox">
          <input type="checkbox" class="form-check-input" id="gdprConsent" 
                 name="gdpr_consent" required>
          <label class="gdpr-text" for="gdprConsent">
            I agree to the <a href="/privacy-policy" target="_blank">Privacy Policy</a> 
            and consent to data processing as described. I understand I can withdraw 
            consent at any time through my account settings.
          </label>
        </div>
      </div>
      
      <!-- Submit Button -->
      <button type="submit" class="submit-button" id="submitBtn">
        <span id="submitText">‚ú® Create My Account</span>
        <div id="submitSpinner" class="spinner" style="display: none;"></div>
      </button>
      
    </form>
    
    <!-- Login Link -->
    <div style="text-align: center; margin-top: var(--space-lg); padding-top: var(--space-lg); border-top: 1px solid var(--light-border);">
      <p style="color: var(--text-secondary); margin: 0;">
        Already have an account? 
        <a href="/login" style="color: var(--teal); text-decoration: none; font-weight: 500;">Sign in here</a>
      </p>
    </div>
    
  </div>
  
  <!-- Learn More Link -->
  <div style="text-align: center;">
    <a href="/learn-more" class="btn-base btn-outline-secondary">
      üì£ Learn More About Coaches Hub
    </a>
  </div>
  
</div>
{% endblock %}

{% block footer %}
<footer style="text-align: center; color: var(--text-secondary); padding: var(--space-lg) 0;">
  <p style="font-size: 0.875rem; margin: 0;">
    Built by Jamie ‚Ä¢ v2.2 ‚Ä¢ 
    <a href="/contact" style="color: var(--teal); text-decoration: none;">Contact Us</a> ‚Ä¢ 
    <a href="/privacy-policy" style="color: var(--teal); text-decoration: none;">Privacy</a>
  </p>
</footer>
{% endblock %}

{% block extra_js %}
<script>
// Enhanced registration form with improved security and UX
document.addEventListener('DOMContentLoaded', function() {
  const form = document.getElementById('registrationForm');
  const submitBtn = document.getElementById('submitBtn');
  const submitText = document.getElementById('submitText');
  const submitSpinner = document.getElementById('submitSpinner');
  
  // Form validation with real-time feedback
  const validators = {
    username: {
      element: document.getElementById('username'),
      rules: [
        { test: (val) => val.length >= 3, message: 'Username must be at least 3 characters' },
        { test: (val) => val.length <= 20, message: 'Username must be 20 characters or less' },
        { test: (val) => /^[a-zA-Z0-9_-]+$/.test(val), message: 'Username can only contain letters, numbers, - and _' },
        { test: (val) => /^[a-zA-Z]/.test(val), message: 'Username must start with a letter' }
      ]
    },
    email: {
      element: document.getElementById('email'),
      rules: [
        { test: (val) => val.includes('@'), message: 'Please enter a valid email address' },
        { test: (val) => val.split('@')[1]?.includes('.'), message: 'Please enter a valid email domain' },
        { test: (val) => val.length <= 254, message: 'Email address is too long' }
      ]
    },
    password: {
      element: document.getElementById('password'),
      rules: [
        { test: (val) => val.length >= 8, message: 'Password must be at least 8 characters' },
        { test: (val) => /[A-Z]/.test(val), message: 'Password must contain an uppercase letter' },
        { test: (val) => /[a-z]/.test(val), message: 'Password must contain a lowercase letter' },
        { test: (val) => /[0-9]/.test(val), message: 'Password must contain a number' }
      ]
    }
  };
  
  // Rate limiting for form submission
  let lastSubmitTime = 0;
  const SUBMIT_COOLDOWN = 3000; // 3 seconds
  
  // Setup validation for each field
  Object.keys(validators).forEach(fieldName => {
    const validator = validators[fieldName];
    const element = validator.element;
    
    if (!element) return;
    
    // Real-time validation on input
    element.addEventListener('input', debounce(() => validateField(fieldName), 300));
    element.addEventListener('blur', () => validateField(fieldName));
    
    // Clear validation styling on focus
    element.addEventListener('focus', () => clearFieldValidation(fieldName));
  });
  
  // Password strength indicator
  const passwordField = document.getElementById('password');
  const strengthIndicator = document.getElementById('passwordStrength');
  const strengthFill = document.getElementById('strengthFill');
  const strengthText = document.getElementById('strengthText');
  
  passwordField.addEventListener('input', function() {
    const password = this.value;
    const strength = calculatePasswordStrength(password);
    updatePasswordStrength(strength);
  });
  
  function calculatePasswordStrength(password) {
    let score = 0;
    let feedback = [];
    
    if (password.length >= 8) score += 1;
    else feedback.push('At least 8 characters');
    
    if (/[A-Z]/.test(password)) score += 1;
    else feedback.push('Uppercase letter');
    
    if (/[a-z]/.test(password)) score += 1;
    else feedback.push('Lowercase letter');
    
    if (/[0-9]/.test(password)) score += 1;
    else feedback.push('Number');
    
    if (/[^A-Za-z0-9]/.test(password)) score += 1;
    else feedback.push('Special character');
    
    return { score, feedback };
  }
  
  function updatePasswordStrength(strength) {
    const { score, feedback } = strength;
    
    if (passwordField.value.length === 0) {
      strengthIndicator.classList.remove('show');
      return;
    }
    
    strengthIndicator.classList.add('show');
    
    // Remove all strength classes
    strengthFill.classList.remove('weak', 'medium', 'strong');
    
    if (score <= 2) {
      strengthFill.classList.add('weak');
      strengthText.textContent = 'Password strength: Weak';
    } else if (score <= 4) {
      strengthFill.classList.add('medium');
      strengthText.textContent = 'Password strength: Medium';
    } else {
      strengthFill.classList.add('strong');
      strengthText.textContent = 'Password strength: Strong';
    }
    
    if (feedback.length > 0) {
      strengthText.textContent += ` ‚Ä¢ Missing: ${feedback.join(', ')}`;
    }
  }
  
  function validateField(fieldName) {
    const validator = validators[fieldName];
    const element = validator.element;
    const value = element.value.trim();
    
    const errorElement = document.getElementById(`${fieldName}-error`);
    const successElement = document.getElementById(`${fieldName}-success`);
    
    // Check if field is required and empty
    if (element.hasAttribute('required') && !value) {
      showFieldError(fieldName, `${fieldName.charAt(0).toUpperCase() + fieldName.slice(1)} is required`);
      return false;
    }
    
    // Run validation rules
    for (const rule of validator.rules) {
      if (value && !rule.test(value)) {
        showFieldError(fieldName, rule.message);
        return false;
      }
    }
    
    // Field is valid
    showFieldSuccess(fieldName);
    return true;
  }
  
  function showFieldError(fieldName, message) {
    const element = validators[fieldName].element;
    const errorElement = document.getElementById(`${fieldName}-error`);
    const successElement = document.getElementById(`${fieldName}-success`);
    
    element.classList.remove('valid');
    element.classList.add('error');
    errorElement.textContent = message;
    errorElement.style.display = 'flex';
    successElement.style.display = 'none';
  }
  
  function showFieldSuccess(fieldName) {
    const element = validators[fieldName].element;
    const errorElement = document.getElementById(`${fieldName}-error`);
    const successElement = document.getElementById(`${fieldName}-success`);
    
    element.classList.remove('error');
    element.classList.add('valid');
    errorElement.style.display = 'none';
    successElement.textContent = 'Looks good!';
    successElement.style.display = 'flex';
  }
  
  function clearFieldValidation(fieldName) {
    const element = validators[fieldName].element;
    const errorElement = document.getElementById(`${fieldName}-error`);
    const successElement = document.getElementById(`${fieldName}-success`);
    
    element.classList.remove('error', 'valid');
    errorElement.style.display = 'none';
    successElement.style.display = 'none';
  }
  
  // Form submission with enhanced security
  form.addEventListener('submit', function(e) {
    e.preventDefault();
    
    // Rate limiting check
    const now = Date.now();
    if (now - lastSubmitTime < SUBMIT_COOLDOWN) {
      showToast('‚è≥ Please wait before submitting again', 'warning');
      return;
    }
    
    // Validate all fields
    let allValid = true;
    Object.keys(validators).forEach(fieldName => {
      if (!validateField(fieldName)) {
        allValid = false;
      }
    });
    
    // Validate CAPTCHA
    const captchaAnswer = document.getElementById('captcha_answer').value.trim();
    if (!captchaAnswer) {
      showToast('‚ö†Ô∏è Please solve the security verification', 'error');
      document.getElementById('captcha_answer').focus();
      allValid = false;
    }
    
    // Validate GDPR consent
    const gdprConsent = document.getElementById('gdprConsent');
    if (!gdprConsent.checked) {
      showToast('‚ö†Ô∏è Please accept the privacy policy to continue', 'error');
      gdprConsent.focus();
      allValid = false;
    }
    
    if (!allValid) {
      // Scroll to first error
      const firstError = form.querySelector('.error');
      if (firstError) {
        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstError.focus();
      }
      return;
    }
    
    // Show loading state
    submitText.textContent = 'Creating Account...';
    submitSpinner.style.display = 'block';
    submitBtn.disabled = true;
    lastSubmitTime = now;
    
    // Add security token (CSRF protection simulation)
    const securityToken = generateSecurityToken();
    const tokenInput = document.createElement('input');
    tokenInput.type = 'hidden';
    tokenInput.name = 'security_token';
    tokenInput.value = securityToken;
    form.appendChild(tokenInput);
    
    // Submit form
    form.submit();
  });
  
  // Generate a simple security token (in real app, this would be server-generated)
  function generateSecurityToken() {
    return btoa(Date.now() + Math.random().toString()).substring(0, 32);
  }
  
  // Debounce function for input validation
  function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
      const later = () => {
        clearTimeout(timeout);
        func(...args);
      };
      clearTimeout(timeout);
      timeout = setTimeout(later, wait);
    };
  }
});

// Enhanced CAPTCHA functionality
function refreshCaptcha() {
  const refreshBtn = event.target;
  const originalText = refreshBtn.innerHTML;
  
  refreshBtn.innerHTML = '‚è≥ Loading...';
  refreshBtn.disabled = true;
  
  fetch('/refresh-captcha', {
    method: 'POST',
    headers: { 
      'Content-Type': 'application/json',
      'X-Requested-With': 'XMLHttpRequest'
    },
    credentials: 'same-origin'
  })
  .then(response => {
    if (!response.ok) throw new Error('Network response was not ok');
    return response.json();
  })
  .then(data => {
    if (data.success) {
      document.querySelector('.captcha-question').textContent = data.question;
      document.getElementById('captcha_answer').value = '';
      document.getElementById('captcha_answer').focus();
      showToast('üîÑ New security question generated', 'success');
    } else {
      throw new Error(data.error || 'Failed to refresh question');
    }
  })
  .catch(error => {
    console.error('CAPTCHA refresh error:', error);
    showToast('‚ùå Could not refresh question. Please try again.', 'error');
  })
  .finally(() => {
    refreshBtn.innerHTML = originalText;
    refreshBtn.disabled = false;
  });
}

// PWA Installation functionality
document.addEventListener('DOMContentLoaded', function() {
  let deferredPrompt;
  const installButton = document.getElementById('installButton');
  const dismissButton = document.getElementById('dismissButton');
  const installBanner = document.getElementById('installBanner');
  
  // Listen for install prompt
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    
    // Check if should show banner
    if (shouldShowInstallBanner()) {
      setTimeout(() => {
        installBanner.style.display = 'block';
        installBanner.classList.add('fade-in');
      }, 2000);
    }
  });
  
  // Handle install
  installButton?.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    
    installButton.innerHTML = '‚è≥ Installing...';
    installButton.disabled = true;
    
    try {
      deferredPrompt.prompt();
      const { outcome } = await deferredPrompt.userChoice;
      
      if (outcome === 'accepted') {
        localStorage.setItem('appInstalled', 'true');
        showToast('üéæ App installed successfully!', 'success');
      }
    } catch (error) {
      console.error('Install error:', error);
      showToast('‚ùå Installation failed', 'error');
    } finally {
      deferredPrompt = null;
      installBanner.style.display = 'none';
    }
  });
  
  // Handle dismiss
  dismissButton?.addEventListener('click', () => {
    installBanner.style.display = 'none';
    localStorage.setItem('installDismissed', Date.now());
    showToast('üí≠ You can install later from your browser menu', 'info');
  });
  
  function shouldShowInstallBanner() {
    if (localStorage.getItem('appInstalled') === 'true') return false;
    
    const lastDismissed = parseInt(localStorage.getItem('installDismissed') || 0);
    const dismissCooldown = 7 * 24 * 60 * 60 * 1000; // 7 days
    
    return !lastDismissed || (Date.now() - lastDismissed > dismissCooldown);
  }
});

// Enhanced toast notification system
function showToast(message, type = 'info') {
  // Remove existing toasts
  document.querySelectorAll('.toast-notification').forEach(toast => toast.remove());
  
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  
  const colors = {
    success: 'var(--success)',
    error: 'var(--danger)',
    warning: 'var(--warning)',
    info: 'var(--info)'
  };
  
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: ${colors[type] || colors.info};
    color: white;
    padding: 1rem 1.5rem;
    border-radius: var(--btn-radius);
    z-index: 9999;
    font-size: 0.9rem;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    animation: slideInRight 0.3s ease;
    max-width: 350px;
    word-wrap: break-word;
  `;
  
  // Add close button
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '√ó';
  closeBtn.style.cssText = `
    background: none;
    border: none;
    color: white;
    font-size: 1.2rem;
    font-weight: bold;
    margin-left: 1rem;
    cursor: pointer;
    opacity: 0.8;
  `;
  closeBtn.addEventListener('click', () => toast.remove());
  
  toast.innerHTML = message;
  toast.appendChild(closeBtn);
  document.body.appendChild(toast);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (toast.parentNode) {
      toast.style.animation = 'slideOutRight 0.3s ease';
      setTimeout(() => toast.remove(), 300);
    }
  }, 5000);
}

// Add required CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Keyboard accessibility improvements
document.addEventListener('keydown', function(e) {
  // Submit form with Ctrl/Cmd + Enter
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('submitBtn').click();
  }
  
  // Refresh CAPTCHA with Ctrl/Cmd + R when CAPTCHA input is focused
  if ((e.ctrlKey || e.metaKey) && e.key === 'r' && document.activeElement === document.getElementById('captcha_answer')) {
    e.preventDefault();
    refreshCaptcha();
  }
});

// Auto-dismiss alerts after page load
setTimeout(() => {
  document.querySelectorAll('.alert').forEach(alert => {
    if (alert.classList.contains('show')) {
      alert.classList.remove('show');
      alert.classList.add('fade');
      setTimeout(() => alert.remove(), 500);
    }
  });
}, 5000);

// Form auto-save for better UX (saves to sessionStorage)
const formFields = ['username', 'email', 'postcode'];
formFields.forEach(fieldName => {
  const field = document.getElementById(fieldName);
  if (!field) return;
  
  // Load saved value
  const savedValue = sessionStorage.getItem(`register_${fieldName}`);
  if (savedValue) {
    field.value = savedValue;
  }
  
  // Save on input
  field.addEventListener('input', debounce(() => {
    sessionStorage.setItem(`register_${fieldName}`, field.value);
  }, 500));
});

// Clear saved data on successful submission
window.addEventListener('beforeunload', function() {
  if (document.getElementById('submitBtn').disabled) {
    // Form is being submitted, clear saved data
    formFields.forEach(fieldName => {
      sessionStorage.removeItem(`register_${fieldName}`);
    });
  }
});

function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}
</script>
{% endblock %}